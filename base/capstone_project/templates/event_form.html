{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}{% if event %}Edit Event{% else %}Create Event{% endif %} - Knights of Columbus{% endblock %}

{% block page_title %}{% if event %}Edit Event{% else %}Create Event{% endif %}{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Events</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">{% if event %}Edit Event{% else %}Create Event{% endif %}</span>
{% endblock %}

{% block header_actions %}
<a href="{% url 'event_list' %}" class="btn btn--ghost">
  <i class="fas fa-arrow-left"></i> Back to Events
</a>
{% endblock %}

{% block extra_css %}
<style>
  .form-card {
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    overflow: hidden;
  }

  .form-card-body {
    padding: var(--space-6);
  }

  .form-section {
    margin-bottom: var(--space-8);
  }

  .form-section:last-child {
    margin-bottom: 0;
  }

  .form-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--neutral-200);
  }

  .form-section-title i {
    color: var(--primary-600);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .form-grid--full {
    grid-template-columns: 1fr;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .form-group--full {
    grid-column: span 2;
  }

  .form-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--neutral-700);
  }

  .form-label--required::after {
    content: ' *';
    color: var(--error-500);
  }

  .form-input,
  .form-select,
  .form-textarea {
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .form-input:disabled,
  .form-select:disabled {
    background: var(--neutral-100);
    cursor: not-allowed;
  }

  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }

  .form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }

  .form-checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
  }

  .form-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: var(--radius-md);
    border: 2px solid var(--neutral-300);
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .form-checkbox:checked {
    background: var(--primary-600);
    border-color: var(--primary-600);
  }

  .checkbox-content {
    flex: 1;
  }

  .checkbox-label {
    font-weight: var(--font-medium);
    color: var(--neutral-800);
    display: block;
  }

  .checkbox-help {
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-top: 2px;
  }

  .form-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-5) var(--space-6);
    background: var(--neutral-50);
    border-top: 1px solid var(--neutral-200);
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .form-group--full {
      grid-column: span 1;
    }

    .form-footer {
      flex-direction: column;
    }

    .form-footer .btn {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<form method="post" class="form-card">
  {% csrf_token %}

  <div class="form-card-body">
    <!-- Basic Info -->
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-info-circle"></i> Basic Information</h3>
      <div class="form-grid">
        <div class="form-group form-group--full">
          <label class="form-label form-label--required">Event Name</label>
          <input type="text" name="name" class="form-input" value="{% if event %}{{ event.name }}{% endif %}" required
            placeholder="Enter event name">
        </div>

        <div class="form-group form-group--full">
          <label class="form-label form-label--required">Description</label>
          <textarea name="description" class="form-textarea" required
            placeholder="Describe the event...">{% if event %}{{ event.description }}{% endif %}</textarea>
        </div>

        <div class="form-group">
          <label class="form-label form-label--required">Category</label>
          <select name="category" id="category" class="form-select" required onchange="loadSubcategories()">
            <option value="" disabled {% if not event %}selected{% endif %}>Select category</option>
            <option value="Exemplification" {% if event %}{% if event.category=='Exemplification' %}selected{% endif
              %}{% endif %}>Exemplification</option>
            <option value="Service Program" {% if event %}{% if event.category=='Service Program' %}selected{% endif
              %}{% endif %}>Service Program</option>
            <option value="Council Meeting" {% if event %}{% if event.category=='Council Meeting' %}selected{% endif
              %}{% endif %}>Council Meeting</option>
            <option value="Assembly Meeting" {% if event %}{% if event.category=='Assembly Meeting' %}selected{% endif
              %}{% endif %}>Assembly Meeting</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Subcategory</label>
          <select name="subcategory" id="subcategory" class="form-select" disabled>
            <option value="">Select subcategory</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Location -->
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-map-marker-alt"></i> Location</h3>
      <div class="form-grid">
        <div class="form-group form-group--full">
          <label class="form-label form-label--required">Street Address</label>
          <input type="text" name="street" class="form-input" value="{% if event %}{{ event.street }}{% endif %}"
            required placeholder="Street address">
        </div>

        <div class="form-group">
          <label class="form-label form-label--required">Province</label>
          {% if event %}
          <input type="text" name="province" class="form-input" value="{{ event.province }}" required>
          {% else %}
          <select name="province" id="province" class="form-select" required onchange="loadCities()">
            <option value="" disabled selected>Select province</option>
            <option value="Batangas">Batangas</option>
            <option value="Cavite">Cavite</option>
            <option value="Laguna">Laguna</option>
            <option value="Quezon">Quezon</option>
            <option value="Rizal">Rizal</option>
          </select>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label form-label--required">City/Municipality</label>
          {% if event %}
          <input type="text" name="city" class="form-input" value="{{ event.city }}" required>
          {% else %}
          <select name="city" id="city" class="form-select" required onchange="loadBarangays()" disabled>
            <option value="" disabled selected>Select city</option>
          </select>
          {% endif %}
        </div>

        <div class="form-group">
          <label class="form-label form-label--required">Barangay</label>
          {% if event %}
          <input type="text" name="barangay" class="form-input" value="{{ event.barangay }}" required>
          {% else %}
          <select name="barangay" id="barangay" class="form-select" required disabled>
            <option value="" disabled selected>Select barangay</option>
          </select>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Schedule -->
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-calendar-alt"></i> Schedule</h3>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label form-label--required">Start Date</label>
          <input type="date" name="date_from" id="date_from" class="form-input"
            value="{% if event %}{{ event.date_from|date:'Y-m-d' }}{% endif %}" required>
        </div>

        <div class="form-group">
          <label class="form-label form-label--required">End Date</label>
          <input type="date" name="date_until" id="date_until" class="form-input"
            value="{% if event %}{{ event.date_until|date:'Y-m-d' }}{% endif %}" required>
        </div>
      </div>
    </div>

    <!-- Admin Options -->
    {% if user.role == 'admin' %}
    <div class="form-section">
      <h3 class="form-section-title"><i class="fas fa-cog"></i> Configuration</h3>
      <div class="form-grid form-grid--full">
        <div class="form-checkbox-group">
          <input type="checkbox" name="is_global" id="is_global" class="form-checkbox" {% if event %}{% if
            event.is_global %}checked{% endif %}{% endif %}>
          <div class="checkbox-content">
            <label for="is_global" class="checkbox-label">Global Event</label>
            <span class="checkbox-help">This event will be visible to all councils</span>
          </div>
        </div>

        <div class="form-group" id="council-container" {% if event %}{% if event.is_global %}style="display:none" {%
          endif %}{% endif %}>
          <label class="form-label form-label--required">Council</label>
          <select name="council_id" id="council" class="form-select" {% if event %}{% if not event.is_global
            %}required{% endif %}{% else %}required{% endif %}>
            <option value="" disabled {% if event %}{% if not event.council %}selected{% endif %}{% else %}selected{%
              endif %}>Select council</option>
            {% for council in councils %}
            <option value="{{ council.id }}" {% if event %}{% if event.council.id==council.id %}selected{% endif %}{%
              endif %}>{{ council.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="form-footer">
    <a href="{% url 'event_list' %}" class="btn btn--ghost">Cancel</a>
    <button type="submit" class="btn btn--primary">
      <i class="fas fa-{% if event %}save{% else %}plus{% endif %}"></i>
      {% if event %}Update Event{% elif user.role == 'admin' %}Add Event{% else %}Submit for Approval{% endif %}
    </button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const dateFrom = document.getElementById('date_from');
    const dateUntil = document.getElementById('date_until');

    {% if not event %}
    const today = new Date().toISOString().split('T')[0];
    dateFrom.min = today;
    {% endif %}

    dateFrom.addEventListener('change', function () {
      dateUntil.min = dateFrom.value;
      if (dateUntil.value && dateUntil.value < dateFrom.value) {
        dateUntil.value = dateFrom.value;
      }
    });

    const globalCheckbox = document.getElementById('is_global');
    const councilContainer = document.getElementById('council-container');
    const councilSelect = document.getElementById('council');

    if (globalCheckbox) {
      globalCheckbox.addEventListener('change', function () {
        councilContainer.style.display = this.checked ? 'none' : 'block';
        councilSelect.required = !this.checked;
      });
    }

    loadSubcategories();
  });

  const categoryData = {
    "Exemplification": ["1st", "2nd", "3rd", "4th"],
    "Service Program": ["Faith", "Family", "Life", "Community"],
    "Council Meeting": [],
    "Assembly Meeting": ["Renewal of Obligation", "Meeting"]
  };

  function loadSubcategories() {
    const category = document.getElementById('category').value;
    const subcategory = document.getElementById('subcategory');
    const currentValue = '{{ event.subcategory|default:"" }}';

    subcategory.innerHTML = '<option value="">Select subcategory</option>';
    subcategory.disabled = true;

    if (category && categoryData[category]) {
      const subs = categoryData[category];
      if (subs.length > 0) {
        subcategory.disabled = false;
        subs.forEach(function (s) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          if (s === currentValue) opt.selected = true;
          subcategory.appendChild(opt);
        });
      } else {
        subcategory.innerHTML = '<option value="N/A" selected>N/A</option>';
        subcategory.disabled = false;
      }
    }
  }

  {% if not event %}
  const locationData = {
    "Batangas": {
      "Batangas City": ["Alangilan", "Balagtas", "Cuta", "Kumintang Ibaba", "Poblacion"],
      "Lipa City": ["Adya", "Balele", "Marawoy", "Poblacion", "Sabang"],
      "Tanauan City": ["Altura Bata", "Darasa", "Janopol", "Poblacion"]
    },
    "Cavite": {
      "Bacoor": ["Alima", "Aniban", "Molino", "Niog", "Zapote"],
      "Dasmariñas": ["Burol", "Paliparan", "Sabang", "Salawag"],
      "Tagaytay": ["Asisan", "Iruhin", "Kaybagal", "Mendez Crossing"]
    },
    "Laguna": {
      "Calamba": ["Bagong Kalsada", "Canlubang", "Pansol", "Real"],
      "San Pablo": ["Concepcion", "San Lucas", "San Rafael"],
      "Santa Rosa": ["Aplaya", "Balibago", "Dita", "Macabling"]
    },
    "Quezon": {
      "Lucena": ["Barra", "Cotta", "Dalahican", "Isabang"],
      "Tayabas": ["Alitao", "Camaysa", "Gibanga"],
      "Candelaria": ["Buenavista", "Malabanban", "Pahinga"]
    },
    "Rizal": {
      "Antipolo": ["Cupang", "Dalig", "Mayamot", "San Juan"],
      "Cainta": ["San Andres", "San Juan", "Santa Rosa"],
      "Taytay": ["Dolores", "Muzon", "San Isidro"]
    }
  };

  function loadCities() {
    const province = document.getElementById('province').value;
    const city = document.getElementById('city');
    const barangay = document.getElementById('barangay');

    city.innerHTML = '<option value="" disabled selected>Select city</option>';
    city.disabled = false;
    barangay.innerHTML = '<option value="" disabled selected>Select barangay</option>';
    barangay.disabled = true;

    if (province && locationData[province]) {
      Object.keys(locationData[province]).forEach(function (c) {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        city.appendChild(opt);
      });
    }
  }

  function loadBarangays() {
    const province = document.getElementById('province').value;
    const city = document.getElementById('city').value;
    const barangay = document.getElementById('barangay');

    barangay.innerHTML = '<option value="" disabled selected>Select barangay</option>';
    barangay.disabled = false;

    if (province && city && locationData[province] && locationData[province][city]) {
      locationData[province][city].forEach(function (b) {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        barangay.appendChild(opt);
      });
    }
  }
  {% endif %}
</script>
{% endblock %}
