{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Manage Councils - Knights of Columbus{% endblock %}
{% block page_title %}Manage Councils{% endblock %}
{% block page_subtitle %}Add, edit, or remove councils{% endblock %}

{% block content %}
<!-- Action Header -->
<div class="card mb-6">
  <div class="card-body flex items-center justify-between flex-wrap gap-4">
    <div>
      <h3 class="text-lg font-semibold" style="color: var(--text-primary); margin: 0;">Council Directory</h3>
      <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0.25rem 0 0 0;">Manage all councils in the
        diocese</p>
    </div>
    <button class="btn btn--primary" onclick="openAddCouncilModal()">
      <i class="fas fa-plus"></i>
      <span>Add New Council</span>
    </button>
  </div>
</div>

<!-- Search Bar -->
<div class="card mb-6">
  <div class="card-body">
    <div class="form-group" style="margin: 0;">
      <div style="position: relative;">
        <i class="fas fa-search"
          style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
        <input type="text" id="councilSearchInput" placeholder="Search councils by name or location..."
          class="form-input" style="padding-left: 2.5rem;">
      </div>
    </div>
  </div>
</div>

<!-- Councils Table -->
<div class="card">
  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>Council Name</th>
          <th>Location</th>
          <th>Members</th>
          <th style="text-align: center;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for data in council_data %}
        <tr data-name="{{ data.council.name }}" data-district="{{ data.council.district }}">
          <td>
            <div style="font-weight: 600; color: var(--text-primary);">{{ data.council.name }}</div>
          </td>
          <td>
            {% if data.council.location_city %}<div style="color: var(--text-primary);">{{ data.council.location_city
              }}, {{ data.council.location_province }}</div>{% if data.council.location_barangay %}<div
              style="font-size: 0.75rem; color: var(--text-muted);">{{ data.council.location_barangay }}</div>{% endif
            %}{% else %}<span style="color: var(--text-muted); font-style: italic;">Not set</span>{% endif %}
          </td>
          <td>
            <span class="badge badge--primary">{{ data.member_count }} member{{ data.member_count|pluralize }}</span>
          </td>
          <td>
            <div class="flex items-center justify-center gap-2">
              <button class="btn btn--ghost btn--sm"
                onclick="openEditCouncilModal({{ data.council.pk }}, '{{ data.council.name|escapejs }}', '{{ data.council.location_street|escapejs }}', '{{ data.council.location_barangay|escapejs }}', '{{ data.council.location_city|escapejs }}', '{{ data.council.location_province|escapejs }}', '{{ data.council.location_zip_code|escapejs }}')"
                title="Edit Council"><i class="fas fa-edit"></i></button>
              <button class="btn btn--ghost btn--sm"
                onclick="confirmDeleteCouncil({{ data.council.pk }}, '{{ data.council.name|escapejs }}', {{ data.member_count }})"
                title="Delete Council" style="color: var(--danger-500);"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" style="text-align: center; padding: 3rem; color: var(--text-muted);">
            <i class="fas fa-landmark" style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>
            No councils found. Click "Add New Council" to create one.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Council Modal -->
<div id="addCouncilModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Add New Council</h3>
      <button class="modal-close" onclick="closeAddCouncilModal()">&times;</button>
    </div>
    <form method="POST" action="{% url 'add_council' %}">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Council Name <span class="required">*</span></label>
          <input type="text" id="council_name" name="council_name" class="form-input" required
            placeholder="Enter council name">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Province</label>
            <select id="add_province" name="location_province" class="form-select" onchange="loadAddCities()">
              <option value="">-- Select Province --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">City/Municipality</label>
            <select id="add_city" name="location_city" class="form-select"
              onchange="loadAddBarangays(); updateAddZipCode()" disabled>
              <option value="">-- Select City --</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Barangay</label>
            <select id="add_barangay" name="location_barangay" class="form-select" disabled>
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ZIP Code</label>
            <input type="text" id="add_zip_code" name="location_zip_code" class="form-input" placeholder="Auto-filled"
              readonly>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Street Address</label>
          <input type="text" id="location_street" name="location_street" class="form-input"
            placeholder="Street address (optional)">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeAddCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Add Council</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Council Modal -->
<div id="editCouncilModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Edit Council</h3>
      <button class="modal-close" onclick="closeEditCouncilModal()">&times;</button>
    </div>
    <form method="POST" id="editCouncilForm">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Council Name <span class="required">*</span></label>
          <input type="text" id="edit_council_name" name="council_name" class="form-input" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Province</label>
            <select id="edit_province" name="location_province" class="form-select" onchange="loadEditCities()">
              <option value="">-- Select Province --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">City/Municipality</label>
            <select id="edit_city" name="location_city" class="form-select"
              onchange="loadEditBarangays(); updateEditZipCode()" disabled>
              <option value="">-- Select City --</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Barangay</label>
            <select id="edit_barangay" name="location_barangay" class="form-select" disabled>
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ZIP Code</label>
            <input type="text" id="edit_zip_code" name="location_zip_code" class="form-input" placeholder="Auto-filled"
              readonly>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Street Address</label>
          <input type="text" id="edit_location_street" name="location_street" class="form-input"
            placeholder="Street address (optional)">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeEditCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Update Council</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteCouncilModal" class="modal-overlay">
  <div class="modal-container" style="max-width: 400px;">
    <div class="modal-header">
      <h3 class="modal-title">Confirm Delete</h3>
      <button class="modal-close" onclick="closeDeleteCouncilModal()">&times;</button>
    </div>
    <div class="modal-body" id="deleteCouncilContent">
      <p>Are you sure you want to delete this council?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn--ghost" onclick="closeDeleteCouncilModal()">Cancel</button>
      <form method="POST" id="deleteCouncilForm" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn" style="background: var(--danger-500); color: white;">Delete</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .modal-overlay.show {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
  }

  .modal-container {
    background: white;
    border-radius: var(--radius-xl);
    width: 90%;
    max-width: 560px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
    transform: scale(0.9) translateY(20px);
    transition: transform 0.3s ease;
  }

  .modal-overlay.show .modal-container {
    transform: scale(1) translateY(0);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
  }

  .modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-light);
    background: var(--bg-secondary);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  @media (max-width: 576px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .required {
    color: var(--danger-500);
  }

  /* Warning in delete modal */
  .warning-message {
    background: #fef3cd;
    border: 1px solid #ffc107;
    border-radius: var(--radius-md);
    padding: 1rem;
    text-align: center;
  }

  .warning-message i {
    color: #856404;
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .warning-text {
    color: var(--danger-500);
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // CALABARZON Location Data
  const locationData = {
    "Batangas": {
      "Batangas City": { "zip": "4200", "barangays": ["Alangilan", "Balagtas", "Balete", "Banaba Center", "Bolbok", "Calicanto", "Cuta", "Kumintang Ibaba", "Kumintang Ilaya", "Pallocan Kanluran", "Pallocan Silangan", "Poblacion", "Sampaga", "San Isidro", "Santa Clara", "Simlong", "Tulo"] },
      "Lipa City": { "zip": "4217", "barangays": ["Balintawak", "Bolbok", "Dagatan", "Halang", "Mabini", "Marawoy", "Poblacion Barangay 1", "Poblacion Barangay 2", "Rosario", "San Carlos", "San Jose", "San Sebastian", "Tibig"] },
      "Tanauan City": { "zip": "4232", "barangays": ["Ambulong", "Bagbag", "Banjo East", "Banjo West", "Boot", "Darasa", "Gonzales", "Natatas", "Wawa"] }
    },
    "Cavite": {
      "Bacoor": { "zip": "4102", "barangays": ["Alima", "Aniban", "Banalo", "Bayanan", "Habay", "Ligas", "Mabolo", "Molino", "Niog", "Salinas", "Zapote"] },
      "DasmariÃ±as": { "zip": "4114", "barangays": ["Burol", "Paliparan", "Sabang", "Salawag", "Salitran", "Sampaloc", "San Agustin", "San Jose", "Zone I"] },
      "Tagaytay": { "zip": "4120", "barangays": ["Asisan", "Iruhin", "Kaybagal", "Maharlika", "Mendez Crossing", "San Jose", "Silang Junction", "Sungay"] }
    },
    "Laguna": {
      "Calamba": { "zip": "4027", "barangays": ["Bagong Kalsada", "Canlubang", "Crossing", "Halang", "Lawa", "Makiling", "Mayapa", "Pansol", "Real", "Sucol"] },
      "San Pablo": { "zip": "4000", "barangays": ["Concepcion", "Del Remedio", "Dolores", "San Antonio", "San Crispin", "San Francisco", "San Miguel", "San Rafael"] },
      "Santa Rosa": { "zip": "4026", "barangays": ["Balibago", "Dita", "Don Jose", "Ibaba", "Labas", "Malitlit", "Pooc", "Tagapo"] }
    },
    "Quezon": {
      "Lucena": { "zip": "4301", "barangays": ["Barangay 1", "Barangay 2", "Barangay 3", "Cotta", "Dalahican", "Gulang-Gulang", "Ibabang Dupay", "Isabang", "Market View"] },
      "Tayabas": { "zip": "4327", "barangays": ["Alitao", "Angeles", "Baguio", "Domoit", "Gibanga", "Lakawan", "Opias", "Palola", "Poblacion"] }
    },
    "Rizal": {
      "Antipolo": { "zip": "1870", "barangays": ["Cupang", "Dalig", "Dela Paz", "Mambugan", "Mayamot", "San Isidro", "San Jose", "San Roque"] },
      "Cainta": { "zip": "1900", "barangays": ["San Andres", "San Isidro", "San Juan", "Santa Rosa", "Santo Domingo"] },
      "Taytay": { "zip": "1920", "barangays": ["Dolores", "Muzon", "San Isidro", "San Juan", "Santa Ana"] }
    }
  };

  // Search functionality
  document.getElementById('councilSearchInput').addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.data-table tbody tr');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  // Modal Functions
  function openAddCouncilModal() {
    const modal = document.getElementById('addCouncilModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
  }

  function closeAddCouncilModal() {
    const modal = document.getElementById('addCouncilModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
  }

  function openEditCouncilModal(councilId, councilName, locationStreet, locationBarangay, locationCity, locationProvince, locationZipCode) {
    const modal = document.getElementById('editCouncilModal');
    const form = document.getElementById('editCouncilForm');

    form.action = `/edit-council/${councilId}/`;
    document.getElementById('edit_council_name').value = councilName;
    document.getElementById('edit_location_street').value = locationStreet || '';

    const provinceSelect = document.getElementById('edit_province');
    provinceSelect.value = locationProvince || '';

    if (locationProvince) {
      loadEditCities();
      setTimeout(() => {
        document.getElementById('edit_city').value = locationCity || '';
        if (locationCity) {
          loadEditBarangays();
          setTimeout(() => {
            document.getElementById('edit_barangay').value = locationBarangay || '';
            updateEditZipCode();
          }, 100);
        }
      }, 100);
    }

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
  }

  function closeEditCouncilModal() {
    const modal = document.getElementById('editCouncilModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
  }

  function confirmDeleteCouncil(councilId, councilName, memberCount) {
    const modal = document.getElementById('deleteCouncilModal');
    const content = document.getElementById('deleteCouncilContent');
    const form = document.getElementById('deleteCouncilForm');

    if (memberCount > 0) {
      content.innerHTML = `
        <div class="warning-message">
          <i class="fas fa-exclamation-triangle"></i>
          <p><strong>Cannot delete "${councilName}"</strong></p>
          <p>This council has ${memberCount} active member(s). Please reassign them first.</p>
        </div>
      `;
      form.style.display = 'none';
    } else {
      content.innerHTML = `
        <p>Are you sure you want to delete <strong>"${councilName}"</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      `;
      form.action = `/delete-council/${councilId}/`;
      form.style.display = 'inline';
    }

    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
  }

  function closeDeleteCouncilModal() {
    const modal = document.getElementById('deleteCouncilModal');
    modal.classList.remove('show');
    setTimeout(() => modal.style.display = 'none', 300);
  }

  // Close modals when clicking outside
  window.addEventListener('click', function (event) {
    ['addCouncilModal', 'editCouncilModal', 'deleteCouncilModal'].forEach(id => {
      const modal = document.getElementById(id);
      if (event.target === modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
      }
    });
  });

  // Location dropdown functions
  function loadAddCities() {
    const province = document.getElementById('add_province').value;
    const citySelect = document.getElementById('add_city');
    const barangaySelect = document.getElementById('add_barangay');

    citySelect.innerHTML = '<option value="">-- Select City --</option>';
    citySelect.disabled = !province;
    barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
    barangaySelect.disabled = true;
    document.getElementById('add_zip_code').value = '';

    if (province && locationData[province]) {
      Object.keys(locationData[province]).forEach(city => {
        citySelect.innerHTML += `<option value="${city}">${city}</option>`;
      });
    }
  }

  function loadAddBarangays() {
    const province = document.getElementById('add_province').value;
    const city = document.getElementById('add_city').value;
    const barangaySelect = document.getElementById('add_barangay');

    barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
    barangaySelect.disabled = !city;

    if (province && city && locationData[province] && locationData[province][city]) {
      locationData[province][city].barangays.forEach(brgy => {
        barangaySelect.innerHTML += `<option value="${brgy}">${brgy}</option>`;
      });
    }
  }

  function updateAddZipCode() {
    const province = document.getElementById('add_province').value;
    const city = document.getElementById('add_city').value;
    const zipInput = document.getElementById('add_zip_code');

    if (province && city && locationData[province] && locationData[province][city]) {
      zipInput.value = locationData[province][city].zip;
    } else {
      zipInput.value = '';
    }
  }

  function loadEditCities() {
    const province = document.getElementById('edit_province').value;
    const citySelect = document.getElementById('edit_city');
    const barangaySelect = document.getElementById('edit_barangay');

    citySelect.innerHTML = '<option value="">-- Select City --</option>';
    citySelect.disabled = !province;
    barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
    barangaySelect.disabled = true;
    document.getElementById('edit_zip_code').value = '';

    if (province && locationData[province]) {
      Object.keys(locationData[province]).forEach(city => {
        citySelect.innerHTML += `<option value="${city}">${city}</option>`;
      });
    }
  }

  function loadEditBarangays() {
    const province = document.getElementById('edit_province').value;
    const city = document.getElementById('edit_city').value;
    const barangaySelect = document.getElementById('edit_barangay');

    barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
    barangaySelect.disabled = !city;

    if (province && city && locationData[province] && locationData[province][city]) {
      locationData[province][city].barangays.forEach(brgy => {
        barangaySelect.innerHTML += `<option value="${brgy}">${brgy}</option>`;
      });
    }
  }

  function updateEditZipCode() {
    const province = document.getElementById('edit_province').value;
    const city = document.getElementById('edit_city').value;
    const zipInput = document.getElementById('edit_zip_code');

    if (province && city && locationData[province] && locationData[province][city]) {
      zipInput.value = locationData[province][city].zip;
    } else {
      zipInput.value = '';
    }
  }
</script>
{% endblock %}
