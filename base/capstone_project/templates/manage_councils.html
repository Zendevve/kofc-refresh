{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Manage Councils{% endblock %}
{% block page_title %}Manage Councils{% endblock %}
{% block page_subtitle %}Add, edit, or remove councils{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 1.5rem; padding: 1.25rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600;">Council Directory</h3>
      <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.875rem;">Manage all councils in the diocese</p>
    </div>
    <button class="btn btn--primary" onclick="openAddCouncilModal()"><i class="fas fa-plus"></i> Add New
      Council</button>
  </div>
</div>

<div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
  <input type="text" id="councilSearchInput" placeholder="Search councils by name or location..." class="form-input"
    style="max-width: 400px;">
</div>

<div class="card" style="padding: 0; overflow: hidden;">
  <table class="data-table">
    <thead>
      <tr>
        <th>Council Name</th>
        <th>Location</th>
        <th>Members</th>
        <th style="text-align: center;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for data in council_data %}
      <tr>
        <td style="font-weight: 600;">{{ data.council.name }}</td>
        <td>{% if data.council.location_city %}{{ data.council.location_city }}, {{ data.council.location_province }}{%
          if data.council.location_barangay %}<br><small style="color: #888;">{{ data.council.location_barangay
            }}</small>{% endif %}{% else %}<span style="color: #999; font-style: italic;">Not set</span>{% endif %}</td>
        <td><span class="badge badge--primary">{{ data.member_count }} member{{ data.member_count|pluralize }}</span>
        </td>
        <td style="text-align: center;"><button class="btn btn--ghost btn--sm"
            onclick="openEditCouncilModal({{ data.council.pk }}, '{{ data.council.name|escapejs }}', '{{ data.council.location_street|escapejs }}', '{{ data.council.location_barangay|escapejs }}', '{{ data.council.location_city|escapejs }}', '{{ data.council.location_province|escapejs }}', '{{ data.council.location_zip_code|escapejs }}')"
            title="Edit"><i class="fas fa-edit"></i></button> <button class="btn btn--ghost btn--sm"
            style="color: #ef4444;"
            onclick="confirmDeleteCouncil({{ data.council.pk }}, '{{ data.council.name|escapejs }}', {{ data.member_count }})"
            title="Delete"><i class="fas fa-trash"></i></button></td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4" style="text-align: center; padding: 3rem; color: #999;"><i class="fas fa-landmark"
            style="font-size: 2rem; opacity: 0.3; display: block; margin-bottom: 1rem;"></i>No councils found. Click
          "Add New Council" to create one.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="addCouncilModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Add New Council</h3>
      <button class="modal-close" onclick="closeAddCouncilModal()">&times;</button>
    </div>
    <form method="POST" action="{% url 'add_council' %}">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Council Name *</label><input type="text" name="council_name"
            class="form-input" required></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group"><label class="form-label">Province</label><select id="add_province"
              name="location_province" class="form-select" onchange="loadAddCities()">
              <option value="">-- Select --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select></div>
          <div class="form-group"><label class="form-label">City</label><select id="add_city" name="location_city"
              class="form-select" onchange="loadAddBarangays(); updateAddZipCode()" disabled>
              <option value="">-- Select --</option>
            </select></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group"><label class="form-label">Barangay</label><select id="add_barangay"
              name="location_barangay" class="form-select" disabled>
              <option value="">-- Select --</option>
            </select></div>
          <div class="form-group"><label class="form-label">ZIP Code</label><input type="text" id="add_zip_code"
              name="location_zip_code" class="form-input" readonly></div>
        </div>
        <div class="form-group"><label class="form-label">Street Address</label><input type="text"
            name="location_street" class="form-input"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeAddCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Add Council</button>
      </div>
    </form>
  </div>
</div>

<div id="editCouncilModal" class="modal-overlay">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">Edit Council</h3>
      <button class="modal-close" onclick="closeEditCouncilModal()">&times;</button>
    </div>
    <form method="POST" id="editCouncilForm">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-group"><label class="form-label">Council Name *</label><input type="text"
            id="edit_council_name" name="council_name" class="form-input" required></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group"><label class="form-label">Province</label><select id="edit_province"
              name="location_province" class="form-select" onchange="loadEditCities()">
              <option value="">-- Select --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select></div>
          <div class="form-group"><label class="form-label">City</label><select id="edit_city" name="location_city"
              class="form-select" onchange="loadEditBarangays(); updateEditZipCode()" disabled>
              <option value="">-- Select --</option>
            </select></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group"><label class="form-label">Barangay</label><select id="edit_barangay"
              name="location_barangay" class="form-select" disabled>
              <option value="">-- Select --</option>
            </select></div>
          <div class="form-group"><label class="form-label">ZIP Code</label><input type="text" id="edit_zip_code"
              name="location_zip_code" class="form-input" readonly></div>
        </div>
        <div class="form-group"><label class="form-label">Street Address</label><input type="text"
            id="edit_location_street" name="location_street" class="form-input"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeEditCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Update Council</button>
      </div>
    </form>
  </div>
</div>

<div id="deleteCouncilModal" class="modal-overlay">
  <div class="modal-container" style="max-width: 400px;">
    <div class="modal-header">
      <h3 class="modal-title">Delete Council</h3>
      <button class="modal-close" onclick="closeDeleteCouncilModal()">&times;</button>
    </div>
    <div class="modal-body" id="deleteCouncilContent">
      <p>Are you sure?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn--ghost" onclick="closeDeleteCouncilModal()">Cancel</button>
      <form method="POST" id="deleteCouncilForm" style="display: inline;">{% csrf_token %}<button type="submit"
          class="btn" style="background: #ef4444; color: white;">Delete</button></form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .modal-overlay {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }

  .modal-overlay.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-container {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 560px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
  }

  .modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    max-height: calc(90vh - 140px);
  }

  .modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  const locationData = { "Batangas": { "Batangas City": { "zip": "4200", "barangays": ["Alangilan", "Bolbok", "Cuta", "Pallocan", "Poblacion"] }, "Lipa City": { "zip": "4217", "barangays": ["Balintawak", "Dagatan", "Halang", "Poblacion"] } }, "Cavite": { "Bacoor": { "zip": "4102", "barangays": ["Alima", "Aniban", "Habay", "Molino"] }, "DasmariÃ±as": { "zip": "4114", "barangays": ["Burol", "Paliparan", "Salawag", "Zone I"] }, "Tagaytay": { "zip": "4120", "barangays": ["Asisan", "Kaybagal", "Mendez Crossing", "Silang Junction"] } }, "Laguna": { "Calamba": { "zip": "4027", "barangays": ["Bagong Kalsada", "Canlubang", "Halang", "Pansol"] }, "San Pablo": { "zip": "4000", "barangays": ["Concepcion", "Dolores", "San Antonio", "San Rafael"] }, "Santa Rosa": { "zip": "4026", "barangays": ["Balibago", "Dita", "Ibaba", "Tagapo"] } }, "Quezon": { "Lucena": { "zip": "4301", "barangays": ["Barangay 1", "Cotta", "Dalahican", "Gulang-Gulang", "Isabang"] }, "Tayabas": { "zip": "4327", "barangays": ["Alitao", "Angeles", "Baguio", "Poblacion"] } }, "Rizal": { "Antipolo": { "zip": "1870", "barangays": ["Cupang", "Dela Paz", "Mambugan", "San Isidro"] }, "Cainta": { "zip": "1900", "barangays": ["San Andres", "San Isidro", "San Juan"] } } };

  document.getElementById('councilSearchInput').addEventListener('input', function () {
    const s = this.value.toLowerCase();
    document.querySelectorAll('.data-table tbody tr').forEach(r => { r.style.display = r.textContent.toLowerCase().includes(s) ? '' : 'none'; });
  });

  function openAddCouncilModal() { const m = document.getElementById('addCouncilModal'); m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10); }
  function closeAddCouncilModal() { const m = document.getElementById('addCouncilModal'); m.classList.remove('show'); setTimeout(() => m.style.display = 'none', 300); }

  function openEditCouncilModal(id, name, street, brgy, city, prov, zip) {
    const m = document.getElementById('editCouncilModal');
    document.getElementById('editCouncilForm').action = '/edit-council/' + id + '/';
    document.getElementById('edit_council_name').value = name;
    document.getElementById('edit_location_street').value = street || '';
    document.getElementById('edit_province').value = prov || '';
    if (prov) { loadEditCities(); setTimeout(() => { document.getElementById('edit_city').value = city || ''; if (city) { loadEditBarangays(); setTimeout(() => { document.getElementById('edit_barangay').value = brgy || ''; updateEditZipCode(); }, 100); } }, 100); }
    m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10);
  }
  function closeEditCouncilModal() { const m = document.getElementById('editCouncilModal'); m.classList.remove('show'); setTimeout(() => m.style.display = 'none', 300); }

  function confirmDeleteCouncil(id, name, cnt) {
    const m = document.getElementById('deleteCouncilModal');
    const c = document.getElementById('deleteCouncilContent');
    const f = document.getElementById('deleteCouncilForm');
    if (cnt > 0) { c.innerHTML = '<p style="color: #ef4444;">Cannot delete "' + name + '" - has ' + cnt + ' member(s). Reassign first.</p>'; f.style.display = 'none'; }
    else { c.innerHTML = '<p>Delete "' + name + '"?</p>'; f.action = '/delete-council/' + id + '/'; f.style.display = 'inline'; }
    m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10);
  }
  function closeDeleteCouncilModal() { const m = document.getElementById('deleteCouncilModal'); m.classList.remove('show'); setTimeout(() => m.style.display = 'none', 300); }

  window.addEventListener('click', e => { ['addCouncilModal', 'editCouncilModal', 'deleteCouncilModal'].forEach(id => { const m = document.getElementById(id); if (e.target === m) { m.classList.remove('show'); setTimeout(() => m.style.display = 'none', 300); } }); });

  function loadAddCities() { const p = document.getElementById('add_province').value; const c = document.getElementById('add_city'); const b = document.getElementById('add_barangay'); c.innerHTML = '<option value="">-- Select --</option>'; c.disabled = !p; b.innerHTML = '<option value="">-- Select --</option>'; b.disabled = true; document.getElementById('add_zip_code').value = ''; if (p && locationData[p]) { Object.keys(locationData[p]).forEach(city => { c.innerHTML += '<option value="' + city + '">' + city + '</option>'; }); } }
  function loadAddBarangays() { const p = document.getElementById('add_province').value; const c = document.getElementById('add_city').value; const b = document.getElementById('add_barangay'); b.innerHTML = '<option value="">-- Select --</option>'; b.disabled = !c; if (p && c && locationData[p] && locationData[p][c]) { locationData[p][c].barangays.forEach(brgy => { b.innerHTML += '<option value="' + brgy + '">' + brgy + '</option>'; }); } }
  function updateAddZipCode() { const p = document.getElementById('add_province').value; const c = document.getElementById('add_city').value; const z = document.getElementById('add_zip_code'); if (p && c && locationData[p] && locationData[p][c]) { z.value = locationData[p][c].zip; } else { z.value = ''; } }

  function loadEditCities() { const p = document.getElementById('edit_province').value; const c = document.getElementById('edit_city'); const b = document.getElementById('edit_barangay'); c.innerHTML = '<option value="">-- Select --</option>'; c.disabled = !p; b.innerHTML = '<option value="">-- Select --</option>'; b.disabled = true; document.getElementById('edit_zip_code').value = ''; if (p && locationData[p]) { Object.keys(locationData[p]).forEach(city => { c.innerHTML += '<option value="' + city + '">' + city + '</option>'; }); } }
  function loadEditBarangays() { const p = document.getElementById('edit_province').value; const c = document.getElementById('edit_city').value; const b = document.getElementById('edit_barangay'); b.innerHTML = '<option value="">-- Select --</option>'; b.disabled = !c; if (p && c && locationData[p] && locationData[p][c]) { locationData[p][c].barangays.forEach(brgy => { b.innerHTML += '<option value="' + brgy + '">' + brgy + '</option>'; }); } }
  function updateEditZipCode() { const p = document.getElementById('edit_province').value; const c = document.getElementById('edit_city').value; const z = document.getElementById('edit_zip_code'); if (p && c && locationData[p] && locationData[p][c]) { z.value = locationData[p][c].zip; } else { z.value = ''; } }
</script>
{% endblock %}
