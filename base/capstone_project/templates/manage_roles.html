{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Role Management - Knights of Columbus{% endblock %}

{% block page_title %}Role Management{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Management</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Role Management</span>
{% endblock %}

{% block extra_css %}
<style>
  /* Role Management Specific Styles */
  .role-management-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-6);
  }

  .role-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .role-stat {
    background: white;
    padding: var(--space-4);
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    text-align: center;
  }

  .role-stat-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--primary-700);
  }

  .role-stat-label {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }

  /* Filters */
  .role-filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
    align-items: center;
  }

  .role-search {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .role-search i {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--neutral-400);
  }

  .role-search input {
    width: 100%;
    padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .role-search input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .filter-group {
    display: flex;
    gap: var(--space-2);
  }

  .filter-btn {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--neutral-300);
    background: white;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--neutral-600);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-btn:hover {
    border-color: var(--primary-500);
    color: var(--primary-700);
  }

  .filter-btn.active {
    background: var(--primary-700);
    border-color: var(--primary-700);
    color: white;
  }

  .sort-select {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    background: white;
    cursor: pointer;
  }

  /* View Toggle */
  .view-toggle {
    display: flex;
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .view-toggle-btn {
    padding: var(--space-2) var(--space-3);
    background: white;
    border: none;
    color: var(--neutral-500);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .view-toggle-btn:hover {
    background: var(--neutral-50);
  }

  .view-toggle-btn.active {
    background: var(--primary-700);
    color: white;
  }

  /* User Cards Grid */
  .users-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-4);
  }

  .users-container.list-view {
    grid-template-columns: 1fr;
    gap: var(--space-2);
  }

  .user-card {
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    padding: var(--space-5);
    transition: all var(--transition-base);
  }

  .user-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  /* List View Card */
  .list-view .user-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
  }

  .list-view .user-card:hover {
    transform: none;
    box-shadow: var(--shadow-sm);
  }

  .list-view .user-card-header {
    margin-bottom: 0;
    flex-shrink: 0;
    min-width: 200px;
  }

  .list-view .user-avatar {
    width: 36px;
    height: 36px;
    font-size: var(--text-base);
  }

  .list-view .user-name {
    font-size: var(--text-sm);
  }

  .list-view .user-email {
    font-size: var(--text-xs);
  }

  .list-view .user-card-body {
    flex: 1;
    margin-bottom: 0;
    justify-content: flex-start;
  }

  .list-view .user-card-actions {
    padding-top: 0;
    border-top: none;
    flex-shrink: 0;
  }

  .list-view .action-btn {
    flex: initial;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
  }

  .user-card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    object-fit: cover;
    background: var(--neutral-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-400);
    font-size: var(--text-xl);
    flex-shrink: 0;
  }

  .user-info {
    flex: 1;
    min-width: 0;
  }

  .user-name {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
    margin-bottom: var(--space-1);
  }

  .user-email {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-card-body {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .user-meta {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--neutral-500);
    background: var(--neutral-100);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-md);
  }

  /* Role Badges */
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
  }

  .role-badge.role-officer {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
  }

  .role-badge.role-member {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #1e40af;
  }

  .inactive-badge {
    background: var(--error-50);
    color: var(--error-600);
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-md);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  /* Action Buttons */
  .user-card-actions {
    display: flex;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--neutral-100);
  }

  .action-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .promote-btn {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
  }

  .promote-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  }

  .demote-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
  }

  .demote-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  .details-btn {
    background: var(--neutral-100);
    color: var(--neutral-700);
  }

  .details-btn:hover {
    background: var(--neutral-200);
  }

  /* Modal Styling */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius-xl);
    max-width: 600px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.3s var(--ease-out);
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--neutral-200);
  }

  .modal-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    margin: 0;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    border: none;
    background: var(--neutral-100);
    color: var(--neutral-600);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--neutral-200);
    color: var(--neutral-900);
  }

  #userDetailsContent {
    padding: var(--space-6);
  }

  .user-details-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-5);
    border-bottom: 1px solid var(--neutral-100);
  }

  .user-details-avatar {
    width: 72px;
    height: 72px;
    border-radius: var(--radius-full);
    object-fit: cover;
    background: var(--neutral-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-400);
    font-size: var(--text-2xl);
  }

  .user-details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .detail-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .detail-group.full-width {
    grid-column: span 2;
  }

  .detail-group strong {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--neutral-500);
    text-transform: uppercase;
  }

  .detail-group span {
    font-size: var(--text-sm);
    color: var(--neutral-800);
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--neutral-200);
    background: var(--neutral-50);
  }

  .modal-footer .btn {
    padding: var(--space-2) var(--space-5);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--neutral-500);
  }

  .empty-state i {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-4);
    color: var(--neutral-300);
  }

  @media (max-width: 768px) {
    .role-filters {
      flex-direction: column;
    }

    .role-search {
      min-width: 100%;
    }

    .users-grid {
      grid-template-columns: 1fr;
    }

    .user-details-grid {
      grid-template-columns: 1fr;
    }

    .detail-group.full-width {
      grid-column: span 1;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="role-stats">
  <div class="role-stat">
    <div class="role-stat-value">{{ users|length }}</div>
    <div class="role-stat-label">Total Users</div>
  </div>
  <div class="role-stat">
    <div class="role-stat-value" id="officerCount">0</div>
    <div class="role-stat-label">Officers</div>
  </div>
  <div class="role-stat">
    <div class="role-stat-value" id="memberCount">0</div>
    <div class="role-stat-label">Members</div>
  </div>
</div>

<!-- Filters -->
<div class="role-filters">
  <div class="role-search">
    <i class="fas fa-search"></i>
    <input type="text" id="userSearchInput" placeholder="Search by name, email, or council...">
  </div>
  <div class="filter-group">
    <button class="filter-btn active" data-role="all">All</button>
    <button class="filter-btn" data-role="officer">Officers</button>
    <button class="filter-btn" data-role="member">Members</button>
  </div>
  <select id="sortSelect" class="sort-select">
    <option value="alphabetical">A → Z</option>
    <option value="reverse-alphabetical">Z → A</option>
    <option value="newest">Newest First</option>
    <option value="oldest">Oldest First</option>
  </select>
  <div class="view-toggle">
    <button class="view-toggle-btn active" data-view="grid" title="Grid View"><i class="fas fa-th-large"></i></button>
    <button class="view-toggle-btn" data-view="list" title="List View"><i class="fas fa-list"></i></button>
  </div>
</div>

<!-- Users Container -->
<div class="users-container" id="usersGrid">
  {% for user in users %}
  {% if user.role != 'admin' and not user.is_archived %}
  <div class="user-card" data-role="{{ user.role }}" data-name="{{ user.first_name }} {{ user.last_name }}"
    data-joined="{{ user.date_joined|date:'Y-m-d' }}">
    <div class="user-card-header">
      {% if user.profile_picture %}
      <img src="{{ user.profile_picture.url }}" alt="{{ user.first_name }}" class="user-avatar">
      {% else %}
      <div class="user-avatar"><i class="fas fa-user"></i></div>
      {% endif %}
      <div class="user-info">
        <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="user-email">{{ user.email }}</div>
      </div>
    </div>
    <div class="user-card-body">
      <span class="role-badge role-{{ user.role }}">{{ user.get_role_display }}</span>
      <span class="user-meta"><i class="fas fa-building"></i> {{ user.council.name|default:"No council" }}</span>
      {% with activity_status=user.get_activity_status %}
      {% if activity_status.warning %}
      <span class="inactive-badge"><i class="fas fa-exclamation-triangle"></i> Inactive</span>
      {% endif %}
      {% endwith %}
    </div>
    <div class="user-card-actions">
      {% if user.role == 'member' %}
      <a href="{% url 'promote_user' user.id %}" class="action-btn promote-btn">
        <i class="fas fa-arrow-up"></i> Promote
      </a>
      {% elif user.role == 'officer' %}
      <a href="{% url 'demote_user' user.id %}" class="action-btn demote-btn">
        <i class="fas fa-arrow-down"></i> Demote
      </a>
      {% endif %}
      <button class="action-btn details-btn" onclick="viewUserDetails('{{ user.id }}')">
        <i class="fas fa-info-circle"></i> Details
      </button>
    </div>
  </div>
  {% endif %}
  {% empty %}
  <div class="empty-state">
    <i class="fas fa-users"></i>
    <h3>No users found</h3>
    <p>There are no users to manage at this time.</p>
  </div>
  {% endfor %}
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>User Details</h3>
      <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div id="userDetailsContent">
      <div class="loading" style="text-align: center; padding: 2rem; color: var(--neutral-500);">
        <i class="fas fa-spinner fa-spin"></i> Loading...
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn--primary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Count users by role
    const cards = document.querySelectorAll('.user-card');
    let officers = 0, members = 0;
    cards.forEach(card => {
      if (card.dataset.role === 'officer') officers++;
      if (card.dataset.role === 'member') members++;
    });
    document.getElementById('officerCount').textContent = officers;
    document.getElementById('memberCount').textContent = members;

    // Search functionality
    const searchInput = document.getElementById('userSearchInput');
    searchInput.addEventListener('input', filterUsers);

    // Role filter buttons
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        filterBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        filterUsers();
      });
    });

    // View toggle
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    const usersContainer = document.getElementById('usersGrid');
    viewToggleBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        viewToggleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        if (this.dataset.view === 'list') {
          usersContainer.classList.add('list-view');
        } else {
          usersContainer.classList.remove('list-view');
        }
        // Save preference
        localStorage.setItem('roleManagementView', this.dataset.view);
      });
    });

    // Restore view preference
    const savedView = localStorage.getItem('roleManagementView');
    if (savedView === 'list') {
      document.querySelector('.view-toggle-btn[data-view="list"]').click();
    }

    // Sort functionality
    const sortSelect = document.getElementById('sortSelect');
    sortSelect.addEventListener('change', sortUsers);

    function filterUsers() {
      const searchTerm = searchInput.value.toLowerCase();
      const activeFilter = document.querySelector('.filter-btn.active').dataset.role;

      cards.forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const text = card.textContent.toLowerCase();
        const role = card.dataset.role;

        const matchesSearch = text.includes(searchTerm);
        const matchesRole = activeFilter === 'all' || role === activeFilter;

        card.style.display = matchesSearch && matchesRole ? '' : 'none';
      });
    }

    function sortUsers() {
      const grid = document.getElementById('usersGrid');
      const cardsArr = Array.from(cards);

      cardsArr.sort((a, b) => {
        switch (sortSelect.value) {
          case 'alphabetical':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'reverse-alphabetical':
            return b.dataset.name.localeCompare(a.dataset.name);
          case 'newest':
            return new Date(b.dataset.joined) - new Date(a.dataset.joined);
          case 'oldest':
            return new Date(a.dataset.joined) - new Date(b.dataset.joined);
        }
      });

      cardsArr.forEach(card => grid.appendChild(card));
    }

    // Initial sort
    sortUsers();
  });

  // Modal functions
  function viewUserDetails(userId) {
    const modal = document.getElementById('userDetailsModal');
    const content = document.getElementById('userDetailsContent');
    modal.classList.add('show');

    content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neutral-500);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

    fetch(`/user/${userId}/details/`)
      .then(response => response.json())
      .then(data => {
        content.innerHTML = `
        <div class="user-details-header">
          ${data.profile_picture
            ? `<img src="${data.profile_picture}" class="user-details-avatar">`
            : `<div class="user-details-avatar"><i class="fas fa-user"></i></div>`}
          <div>
            <h4 style="margin: 0 0 var(--space-1); font-size: var(--text-lg);">${data.first_name} ${data.middle_name || ''} ${data.last_name}${data.suffix ? ' ' + data.suffix : ''}</h4>
            <span class="role-badge role-${data.role}">${data.role_display}</span>
          </div>
        </div>
        <div class="user-details-grid">
          <div class="detail-group"><strong>Email</strong><span>${data.email}</span></div>
          <div class="detail-group"><strong>Contact</strong><span>${data.contact_number || 'Not provided'}</span></div>
          <div class="detail-group"><strong>Council</strong><span>${data.council_name || 'No council'}</span></div>
          <div class="detail-group"><strong>Username</strong><span>${data.username}</span></div>
          <div class="detail-group"><strong>Birthday</strong><span>${data.birthday || 'Not provided'}</span></div>
          <div class="detail-group"><strong>Age</strong><span>${data.age || 'N/A'}</span></div>
          <div class="detail-group"><strong>Degree</strong><span>${data.degree_display || 'Not specified'}</span></div>
          <div class="detail-group"><strong>Member Since</strong><span>${data.date_joined}</span></div>
          <div class="detail-group full-width"><strong>Address</strong><span>${data.street ? `${data.street}, ${data.barangay}, ${data.city}, ${data.province} ${data.zip_code}` : 'Not provided'}</span></div>
          <div class="detail-group"><strong>Marital Status</strong><span>${data.marital_status || 'Not provided'}</span></div>
          <div class="detail-group"><strong>Occupation</strong><span>${data.occupation || 'Not provided'}</span></div>
          <div class="detail-group full-width"><strong>Recruiter</strong><span>${data.recruiter_name || (data.voluntary_join ? 'Voluntary Join' : 'Not specified')}</span></div>
          ${data.join_reason ? `<div class="detail-group full-width"><strong>Join Reason</strong><span>${data.join_reason}</span></div>` : ''}
        </div>
      `;
      })
      .catch(error => {
        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--error-600);"><i class="fas fa-exclamation-circle"></i> Error loading details</div>';
      });
  }

  function closeModal() {
    document.getElementById('userDetailsModal').classList.remove('show');
  }

  // Close modal on outside click
  document.getElementById('userDetailsModal').addEventListener('click', function (e) {
    if (e.target === this) closeModal();
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeModal();
  });
</script>
{% endblock %}
