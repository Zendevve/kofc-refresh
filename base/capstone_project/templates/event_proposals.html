{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Event Proposals - Knights of Columbus{% endblock %}
{% block page_title %}Event Proposals{% endblock %}
{% block page_subtitle %}Review and manage pending event proposals{% endblock %}

{% block extra_css %}
<style>
  .proposals-section {
    margin-bottom: var(--space-8);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
    margin-bottom: var(--space-4);
  }

  .section-title i {
    color: var(--primary-500);
  }

  .section-title .count {
    background: var(--primary-100);
    color: var(--primary-700);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
  }

  .proposals-table {
    width: 100%;
    border-collapse: collapse;
  }

  .proposals-table thead {
    background: var(--neutral-50);
  }

  .proposals-table th {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--neutral-200);
  }

  .proposals-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--neutral-100);
    font-size: var(--text-sm);
    color: var(--neutral-700);
    vertical-align: middle;
  }

  .proposals-table tbody tr {
    transition: background var(--transition-fast);
  }

  .proposals-table tbody tr:hover {
    background: var(--neutral-50);
  }

  .event-name {
    font-weight: var(--font-medium);
    color: var(--neutral-900);
  }

  .event-category {
    display: inline-flex;
    padding: var(--space-1) var(--space-2);
    background: var(--primary-50);
    color: var(--primary-700);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .status-badge {
    display: inline-flex;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
  }

  .status-badge.pending {
    background: var(--warning-100);
    color: var(--warning-700);
  }

  .status-badge.approved {
    background: var(--success-100);
    color: var(--success-700);
  }

  .status-badge.rejected {
    background: var(--error-100);
    color: var(--error-700);
  }

  .action-buttons {
    display: flex;
    gap: var(--space-2);
    justify-content: center;
  }

  .action-btn {
    padding: var(--space-2) var(--space-3);
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .action-btn.view {
    background: var(--neutral-100);
    color: var(--neutral-700);
  }

  .action-btn.view:hover {
    background: var(--neutral-200);
  }

  .action-btn.approve {
    background: var(--success-500);
    color: white;
  }

  .action-btn.approve:hover {
    background: var(--success-600);
  }

  .action-btn.reject {
    background: var(--error-500);
    color: white;
  }

  .action-btn.reject:hover {
    background: var(--error-600);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-8);
    color: var(--neutral-500);
  }

  .empty-state i {
    font-size: var(--text-4xl);
    color: var(--neutral-300);
    margin-bottom: var(--space-3);
  }

  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius-2xl);
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modal-header {
    padding: var(--space-5);
    border-bottom: 1px solid var(--neutral-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    color: var(--neutral-900);
  }

  .modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--neutral-100);
    border-radius: var(--radius-full);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--neutral-200);
  }

  .modal-body {
    padding: var(--space-5);
  }

  .event-detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .detail-item {
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: var(--radius-md);
  }

  .detail-item strong {
    display: block;
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-bottom: var(--space-1);
    text-transform: uppercase;
  }

  .detail-item span, .detail-item p {
    font-size: var(--text-sm);
    color: var(--neutral-900);
    margin: 0;
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .rejection-reason {
    background: var(--error-50);
    border: 1px solid var(--error-200);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    margin-top: var(--space-4);
  }

  .rejection-reason strong {
    color: var(--error-700);
    display: block;
    margin-bottom: var(--space-2);
  }

  .rejection-reason p {
    color: var(--error-600);
    margin: 0;
  }

  .modal-footer {
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--neutral-100);
    display: flex;
    justify-content: flex-end;
  }

  @media (max-width: 768px) {
    .proposals-table {
      display: block;
      overflow-x: auto;
    }

    .action-buttons {
      flex-direction: column;
    }

    .event-detail-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Pending Proposals -->
<div class="dashboard-card proposals-section">
  <div class="dashboard-card-body">
    <h2 class="section-title">
      <i class="fas fa-clock"></i>
      Pending Proposals
      {% if pending_events %}<span class="count">{{ pending_events|length }}</span>{% endif %}
    </h2>

    {% if pending_events %}
    <div class="table-responsive">
      <table class="proposals-table">
        <thead>
          <tr>
            <th>Event</th>
            <th>Category</th>
            <th>Date</th>
            <th>Council</th>
            <th>Proposed By</th>
            <th style="text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for event in pending_events %}
          <tr>
            <td><span class="event-name">{{ event.name }}</span></td>
            <td><span class="event-category">{{ event.category }}</span></td>
            <td>{{ event.date_from|date:"M d, Y" }}{% if event.date_until and event.date_until != event.date_from %} - {{ event.date_until|date:"M d, Y" }}{% endif %}</td>
            <td>{{ event.council.name }}</td>
            <td>{{ event.created_by.first_name }} {{ event.created_by.last_name }}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn view" onclick="viewEventDetails('{{ event.id }}')">
                  <i class="fas fa-eye"></i> View
                </button>
                <a href="{% url 'approve_event' event.id %}" class="action-btn approve">
                  <i class="fas fa-check"></i> Approve
                </a>
                <a href="{% url 'reject_event' event.id %}" class="action-btn reject">
                  <i class="fas fa-times"></i> Reject
                </a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fas fa-inbox"></i>
      <p>No pending proposals at this time.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Previous Proposals -->
<div class="dashboard-card">
  <div class="dashboard-card-body">
    <h2 class="section-title">
      <i class="fas fa-history"></i>
      Previous Proposals
    </h2>

    {% if previous_events %}
    <div class="table-responsive">
      <table class="proposals-table">
        <thead>
          <tr>
            <th>Event</th>
            <th>Category</th>
            <th>Date</th>
            <th>Council</th>
            <th>Proposed By</th>
            <th>Status</th>
            <th style="text-align: center;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for event in previous_events %}
          <tr>
            <td><span class="event-name">{{ event.name }}</span></td>
            <td><span class="event-category">{{ event.category }}</span></td>
            <td>{{ event.date_from|date:"M d, Y" }}{% if event.date_until and event.date_until != event.date_from %} - {{ event.date_until|date:"M d, Y" }}{% endif %}</td>
            <td>{{ event.council.name }}</td>
            <td>{{ event.created_by.first_name }} {{ event.created_by.last_name }}</td>
            <td><span class="status-badge {{ event.status }}">{{ event.get_status_display }}</span></td>
            <td>
              <div class="action-buttons">
                <button class="action-btn view" onclick="viewEventDetails('{{ event.id }}')">
                  <i class="fas fa-eye"></i> View
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <i class="fas fa-folder-open"></i>
      <p>No previous proposals.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Event Details</h3>
      <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="eventDetailsContent">
      <div style="text-align: center; padding: var(--space-8); color: var(--neutral-500);">
        <i class="fas fa-spinner fa-spin" style="font-size: var(--text-2xl);"></i>
        <p>Loading...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn--primary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewEventDetails(eventId) {
  const modal = document.getElementById('eventDetailsModal');
  const content = document.getElementById('eventDetailsContent');
  modal.classList.add('show');

  fetch(`/event/${eventId}/details/`)
    .then(response => response.json())
    .then(data => {
      let html = `
        <h4 style="margin: 0 0 var(--space-4); font-size: var(--text-xl); color: var(--neutral-900);">${data.name}</h4>
        <div class="event-detail-grid">
          <div class="detail-item"><strong>Date</strong><span>${data.date_from}${data.date_until ? ' - ' + data.date_until : ''}</span></div>
          <div class="detail-item"><strong>Status</strong><span class="status-badge ${data.status}">${data.status_display}</span></div>
          <div class="detail-item"><strong>Council</strong><span>${data.council_name}</span></div>
          <div class="detail-item"><strong>Created By</strong><span>${data.creator_name}</span></div>
          <div class="detail-item full-width"><strong>Location</strong><span>${data.street}, ${data.barangay}, ${data.city}, ${data.province}</span></div>
          <div class="detail-item full-width"><strong>Description</strong><p>${data.description}</p></div>
        </div>
      `;

      if (data.status === 'rejected' && data.rejection_reason) {
        html += `
          <div class="rejection-reason">
            <strong><i class="fas fa-exclamation-circle"></i> Rejection Reason</strong>
            <p>${data.rejection_reason}</p>
          </div>
        `;
      }

      content.innerHTML = html;
    })
    .catch(error => {
      content.innerHTML = '<p style="color: var(--error-500); text-align: center;">Error loading details.</p>';
    });
}

function closeModal() {
  document.getElementById('eventDetailsModal').classList.remove('show');
}

document.getElementById('eventDetailsModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
{% endblock %}
