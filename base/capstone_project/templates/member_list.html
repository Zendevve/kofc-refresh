{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Members - Knights of Columbus{% endblock %}
{% block page_title %}Members{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Management</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Members</span>
{% endblock %}

{% block header_actions %}
<a href="{% url 'manage_pending_users' %}" class="btn btn--ghost">
  <i class="fas fa-user-clock"></i>
  <span>Pending</span>
</a>
<a href="{% url 'archived_users' %}" class="btn btn--ghost">
  <i class="fas fa-archive"></i>
  <span>Archived</span>
</a>
{% endblock %}

{% block extra_css %}
<style>
  .filters-bar {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    flex-wrap: wrap;
    align-items: center;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-box input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    padding-left: var(--space-10);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .search-box i {
    position: absolute;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--neutral-400);
  }

  .filter-pills {
    display: flex;
    gap: var(--space-2);
  }

  .filter-pill {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-full);
    background: white;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--neutral-600);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .filter-pill:hover {
    border-color: var(--primary-300);
    color: var(--primary-600);
  }

  .filter-pill.active {
    background: var(--primary-600);
    border-color: var(--primary-600);
    color: white;
  }

  .sort-select {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    background: white;
    font-size: var(--text-sm);
    color: var(--neutral-700);
    cursor: pointer;
  }

  .members-table {
    width: 100%;
    border-collapse: collapse;
  }

  .members-table thead {
    background: var(--neutral-50);
  }

  .members-table th {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--neutral-200);
  }

  .members-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--neutral-100);
    font-size: var(--text-sm);
    color: var(--neutral-700);
    vertical-align: middle;
  }

  .members-table tbody tr {
    transition: background var(--transition-fast);
  }

  .members-table tbody tr:hover {
    background: var(--neutral-50);
  }

  .member-cell {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .member-avatar {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
  }

  .member-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .member-avatar i {
    font-size: var(--text-sm);
    color: var(--primary-600);
  }

  .member-name {
    font-weight: var(--font-medium);
    color: var(--neutral-900);
  }

  .role-badge {
    display: inline-flex;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
  }

  .role-badge.admin {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
  }

  .role-badge.officer {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #1e40af;
  }

  .role-badge.member {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
  }

  .role-badge.pending {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
  }

  .inactive-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: var(--warning-50);
    color: var(--warning-600);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    margin-left: var(--space-2);
  }

  .degree-badge {
    padding: var(--space-1) var(--space-2);
    background: var(--neutral-100);
    color: var(--neutral-700);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .action-buttons {
    display: flex;
    gap: var(--space-2);
  }

  .action-btn {
    padding: var(--space-2) var(--space-3);
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .action-btn.details {
    background: var(--primary-50);
    color: var(--primary-700);
  }

  .action-btn.details:hover {
    background: var(--primary-100);
  }

  .action-btn.council {
    background: var(--success-50);
    color: var(--success-700);
  }

  .action-btn.council:hover {
    background: var(--success-100);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--neutral-500);
  }

  .empty-state i {
    font-size: var(--text-4xl);
    color: var(--neutral-300);
    margin-bottom: var(--space-4);
  }

  /* Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius-2xl);
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modal-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--neutral-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: var(--text-xl);
    color: var(--neutral-900);
  }

  .modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--neutral-100);
    border-radius: var(--radius-full);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--neutral-200);
  }

  .modal-body {
    padding: var(--space-6);
  }

  .user-profile-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .profile-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 3px solid var(--primary-200);
  }

  .profile-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .profile-avatar-large i {
    font-size: var(--text-3xl);
    color: var(--primary-600);
  }

  .profile-avatar-large.inactive {
    border-color: var(--warning-400);
    box-shadow: 0 0 0 3px var(--warning-100);
  }

  .user-details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .detail-group {
    padding: var(--space-3);
    background: var(--neutral-50);
    border-radius: var(--radius-md);
  }

  .detail-group strong {
    display: block;
    font-size: var(--text-xs);
    color: var(--neutral-500);
    margin-bottom: var(--space-1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-group span {
    font-size: var(--text-sm);
    color: var(--neutral-900);
  }

  .detail-group.full-width {
    grid-column: 1 / -1;
  }

  .modal-footer {
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--neutral-100);
    display: flex;
    justify-content: flex-end;
  }

  @media (max-width: 768px) {
    .filters-bar {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-pills {
      overflow-x: auto;
      padding-bottom: var(--space-2);
    }

    .members-table {
      display: block;
      overflow-x: auto;
    }

    .user-details-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-card">
  <div class="dashboard-card-body">
    <!-- Filters Bar -->
    <div class="filters-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearchInput" placeholder="Search by name, email, or council...">
      </div>
      <div class="filter-pills">
        <button class="filter-pill active" data-role="all">All</button>
        <button class="filter-pill" data-role="officer">Officers</button>
        <button class="filter-pill" data-role="member">Members</button>
        <button class="filter-pill" data-role="pending">Pending</button>
      </div>
      <select id="sortSelect" class="sort-select">
        <option value="alphabetical">A-Z</option>
        <option value="reverse-alphabetical">Z-A</option>
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
      </select>
    </div>

    <!-- Members Table -->
    <div class="table-responsive">
      <table class="members-table">
        <thead>
          <tr>
            <th>Member</th>
            <th>Council</th>
            <th>Email</th>
            <th>Role</th>
            <th>Degree</th>
            <th style="text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          {% if not user.is_archived %}
          <tr data-role="{{ user.role }}" data-council="{{ user.council.name|default:'' }}" data-name="{{ user.first_name }} {{ user.last_name }}" data-joined="{{ user.date_joined|date:'Y-m-d' }}">
            <td>
              <div class="member-cell">
                <div class="member-avatar">
                  {% if user.profile_picture %}
                  <img src="{{ user.profile_picture.url }}" alt="{{ user.first_name }}">
                  {% else %}
                  <i class="fas fa-user"></i>
                  {% endif %}
                </div>
                <span class="member-name">{{ user.first_name }} {{ user.last_name }}</span>
              </div>
            </td>
            <td>{{ user.council.name|default:"—" }}</td>
            <td>{{ user.email }}</td>
            <td>
              <span class="role-badge {{ user.role }}">{{ user.get_role_display }}</span>
              {% with activity_status=user.get_activity_status %}
              {% if activity_status.warning %}
              <span class="inactive-badge" title="{{ activity_status.message }}">
                <i class="fas fa-exclamation-triangle"></i> Inactive
              </span>
              {% endif %}
              {% endwith %}
            </td>
            <td><span class="degree-badge">{{ user.get_current_degree_display }}</span></td>
            <td>
              <div class="action-buttons" style="justify-content: center;">
                <button class="action-btn details" onclick="viewUserDetails('{{ user.id }}')">
                  <i class="fas fa-info-circle"></i> Details
                </button>
                {% if request.user.role == 'admin' %}
                <a href="{% url 'change_council' user_id=user.id %}" class="action-btn council">
                  <i class="fas fa-exchange-alt"></i> Council
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <i class="fas fa-users-slash"></i>
                <p>No members found.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div id="userDetailsModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Member Details</h3>
      <button class="modal-close" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="userDetailsContent">
      <div style="text-align: center; padding: var(--space-8); color: var(--neutral-500);">
        <i class="fas fa-spinner fa-spin" style="font-size: var(--text-2xl);"></i>
        <p>Loading...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn--primary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('userSearchInput');
  const filterPills = document.querySelectorAll('.filter-pill');
  const sortSelect = document.getElementById('sortSelect');
  const tbody = document.querySelector('.members-table tbody');

  // Search functionality
  searchInput.addEventListener('input', filterTable);

  // Filter pills
  filterPills.forEach(pill => {
    pill.addEventListener('click', function() {
      filterPills.forEach(p => p.classList.remove('active'));
      this.classList.add('active');
      filterTable();
    });
  });

  // Sort functionality
  sortSelect.addEventListener('change', sortTable);

  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const activeFilter = document.querySelector('.filter-pill.active').dataset.role;
    const rows = tbody.querySelectorAll('tr[data-role]');

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const role = row.dataset.role;
      const matchesSearch = text.includes(searchTerm);
      const matchesRole = activeFilter === 'all' || role === activeFilter;
      row.style.display = matchesSearch && matchesRole ? '' : 'none';
    });
  }

  function sortTable() {
    const sortType = sortSelect.value;
    const rows = Array.from(tbody.querySelectorAll('tr[data-role]'));

    rows.sort((a, b) => {
      switch(sortType) {
        case 'alphabetical':
          return a.dataset.name.localeCompare(b.dataset.name);
        case 'reverse-alphabetical':
          return b.dataset.name.localeCompare(a.dataset.name);
        case 'newest':
          return new Date(b.dataset.joined) - new Date(a.dataset.joined);
        case 'oldest':
          return new Date(a.dataset.joined) - new Date(b.dataset.joined);
        default:
          return 0;
      }
    });

    rows.forEach(row => tbody.appendChild(row));
  }

  // Initial sort
  sortTable();
});

// Modal functions
function viewUserDetails(userId) {
  const modal = document.getElementById('userDetailsModal');
  const content = document.getElementById('userDetailsContent');
  modal.classList.add('show');

  fetch(`/user/${userId}/details/`)
    .then(response => response.json())
    .then(data => {
      content.innerHTML = `
        <div class="user-profile-header">
          <div class="profile-avatar-large ${data.is_inactive ? 'inactive' : ''}">
            ${data.profile_picture ?
              `<img src="${data.profile_picture}" alt="Profile">` :
              `<i class="fas fa-user"></i>`}
          </div>
          <div>
            <h4 style="margin: 0; font-size: var(--text-xl); color: var(--neutral-900);">
              ${data.first_name} ${data.middle_name || ''} ${data.last_name} ${data.suffix || ''}
            </h4>
            <span class="role-badge ${data.role}" style="margin-top: var(--space-2);">${data.role_display}</span>
          </div>
        </div>
        <div class="user-details-grid">
          <div class="detail-group"><strong>Email</strong><span>${data.email}</span></div>
          <div class="detail-group"><strong>Contact</strong><span>${data.contact_number || '—'}</span></div>
          <div class="detail-group"><strong>Council</strong><span>${data.council_name || '—'}</span></div>
          <div class="detail-group"><strong>Username</strong><span>${data.username}</span></div>
          <div class="detail-group"><strong>Birthday</strong><span>${data.birthday || '—'}</span></div>
          <div class="detail-group"><strong>Age</strong><span>${data.age || '—'}</span></div>
          <div class="detail-group full-width"><strong>Address</strong><span>${data.street ? `${data.street}, ${data.barangay}, ${data.city}, ${data.province} ${data.zip_code}` : '—'}</span></div>
          <div class="detail-group"><strong>Degree</strong><span>${data.degree_display || '—'}</span></div>
          <div class="detail-group"><strong>Member Since</strong><span>${data.date_joined}</span></div>
          <div class="detail-group"><strong>Marital Status</strong><span>${data.marital_status || '—'}</span></div>
          <div class="detail-group"><strong>Occupation</strong><span>${data.occupation || '—'}</span></div>
          <div class="detail-group"><strong>Recruiter</strong><span>${data.recruiter_name || (data.voluntary_join ? 'Voluntary Join' : '—')}</span></div>
          ${data.join_reason ? `<div class="detail-group full-width"><strong>Join Reason</strong><span>${data.join_reason}</span></div>` : ''}
        </div>
      `;
    })
    .catch(error => {
      content.innerHTML = '<p style="color: var(--error-500); text-align: center;">Error loading details.</p>';
    });
}

function closeModal() {
  document.getElementById('userDetailsModal').classList.remove('show');
}

// Close modal on overlay click
document.getElementById('userDetailsModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
{% endblock %}
