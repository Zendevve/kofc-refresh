{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Take Attendance{% endblock %}
{% block page_title %}Take Attendance{% endblock %}
{% block page_subtitle %}Scan member QR codes to record attendance{% endblock %}

{% block content %}

<div class="dashboard-card">
  <div class="dashboard-card-body">
    <div class="attendance-container">
      <div class="event-selection-section">
        <h3>Select an Event</h3>
        <select id="eventSelect" class="form-select">
          <option value="">Choose an event...</option>
          {% for event in events %}
          <option value="{{ event.id }}" data-event-name="{{ event.name }}">{{ event.name }} ({{ event.date_from|date:"M d, Y" }})</option>
          {% empty %}
          <option value="" disabled>No events available today</option>
          {% endfor %}
        </select>
      </div>

      <div class="scanner-section" style="display: none;">
        <h3>Scan Member QR Code</h3>
        <div class="scanner-wrapper">
          <video id="scannerVideo" width="300" height="300" autoplay playsinline></video>
          <canvas id="scannerCanvas" width="300" height="300" style="display: none;"></canvas>
        </div>
        <button id="startScanner" class="btn btn--primary">
          <i class="fas fa-camera"></i> Start Scanner
        </button>
        <div id="scanResult" class="scan-result"></div>

        <!-- Notification container for scan results -->
        <div class="notification-container"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .attendance-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--space-6);
    gap: var(--space-6);
  }

  .event-selection-section,
  .scanner-section {
    width: 100%;
    max-width: 400px;
  }

  .event-selection-section h3,
  .scanner-section h3 {
    color: var(--primary-600);
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
  }

  .scanner-wrapper {
    display: flex;
    justify-content: center;
    margin-bottom: var(--space-4);
  }

  #scannerVideo {
    border: 3px solid var(--primary-500);
    border-radius: var(--radius-lg);
    background: var(--neutral-900);
  }

  .scan-result {
    margin-top: var(--space-4);
    font-weight: var(--font-semibold);
    color: var(--primary-600);
    min-height: 1.5em;
  }

  .notification-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .notification {
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
    min-width: 280px;
  }

  .notification.success {
    background: var(--success-50);
    border-left: 4px solid var(--success-500);
    color: var(--success-700);
  }

  .notification.error {
    background: var(--error-50);
    border-left: 4px solid var(--error-500);
    color: var(--error-700);
  }

  .notification.info {
    background: var(--info-50);
    border-left: 4px solid var(--info-500);
    color: var(--info-700);
  }

  .notification-close {
    margin-left: auto;
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    opacity: 0.6;
  }

  .notification-close:hover {
    opacity: 1;
  }

  .notification.fade-out {
    animation: fadeOut 0.3s ease forwards;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes fadeOut {
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  @media (max-width: 768px) {
    #scannerVideo {
      width: 250px;
      height: 250px;
    }
  }
</style>

<script>
  // Define the local jsQR path
  var localJsQRPath = "{% static 'js/jsQR.min.js' %}";
</script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" onload="console.log('jsQR loaded from CDN')"
  onerror="console.error('Failed to load jsQR from CDN');
                var s = document.createElement('script');
                s.src = localJsQRPath;
                document.body.appendChild(s);">
                </script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const eventSelect = document.getElementById('eventSelect');
    const scannerSection = document.querySelector('.scanner-section');
    const startScannerBtn = document.getElementById('startScanner');
    const video = document.getElementById('scannerVideo');
    let canvas = document.getElementById('scannerCanvas');
    let canvasContext = canvas ? canvas.getContext('2d') : null;
    const scanResult = document.getElementById('scanResult');
    let scanning = false;
    let stream = null;
    let lastQrData = null;

    if (!eventSelect || !scannerSection || !startScannerBtn || !video || !scanResult) {
      console.error('Missing DOM elements');
      return;
    }

    if (!canvas || !canvasContext) {
      canvas = document.createElement('canvas');
      canvas.width = 300;
      canvas.height = 300;
      canvasContext = canvas.getContext('2d');
    }

    eventSelect.addEventListener('change', function () {
      if (this.value) {
        scannerSection.style.display = 'block';
        scanResult.textContent = 'Select an event and start the scanner.';
      } else {
        scannerSection.style.display = 'none';
      }
    });

    startScannerBtn.addEventListener('click', function () {
      if (!scanning) {
        startScanner();
      } else {
        stopScanner();
      }
    });

    function startScanner() {
      const eventId = eventSelect.value;
      if (!eventId) {
        scanResult.textContent = 'Please select an event first.';
        return;
      }

      navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
      })
        .then(function (mediaStream) {
          stream = mediaStream;
          video.srcObject = stream;
          video.onloadedmetadata = function () {
            video.play();
            scanning = true;
            startScannerBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Scanner';
            startScannerBtn.classList.remove('btn--primary');
            startScannerBtn.classList.add('btn--danger');
            scanResult.textContent = 'Scanning for QR codes...';
            requestAnimationFrame(scan);
          };
        })
        .catch(function (err) {
          console.error("Camera Error:", err);
          scanResult.textContent = `Error: ${err.message}. Check camera permissions.`;
        });
    }

    function stopScanner() {
      scanning = false;
      startScannerBtn.innerHTML = '<i class="fas fa-camera"></i> Start Scanner';
      startScannerBtn.classList.remove('btn--danger');
      startScannerBtn.classList.add('btn--primary');
      scanResult.textContent = 'Scanner stopped.';
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;
      lastQrData = null;
    }

    function scan() {
      if (scanning && video.readyState === video.HAVE_ENOUGH_DATA && canvasContext) {
        if (typeof jsQR === 'undefined') {
          scanResult.textContent = 'Error: QR library not loaded.';
          return;
        }

        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);

        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: 'attemptBoth'
        });

        if (code && code.data !== lastQrData) {
          lastQrData = code.data;
          scanResult.textContent = `Detected: ${code.data}`;
          markAttendance(code.data);
        }
      }
      if (scanning) {
        requestAnimationFrame(scan);
      }
    }

    function markAttendance(qrData) {
      const eventId = eventSelect.value;
      const notificationContainer = document.querySelector('.notification-container');

      // Show processing notification
      showNotification('info', 'Processing attendance...', notificationContainer);

      fetch('/scan-qr/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ qr_data: qrData, event_id: eventId })
      })
        .then(response => response.json())
        .then(data => {
          // Clear processing notification
          notificationContainer.innerHTML = '';

          if (data.status === 'success') {
            showNotification('success', data.message, notificationContainer);
          } else {
            showNotification('error', data.message || 'Failed to mark attendance', notificationContainer);
          }

          // Reset lastQrData after delay to allow re-scanning same QR
          setTimeout(() => { lastQrData = null; }, 3000);
        })
        .catch(error => {
          notificationContainer.innerHTML = '';
          showNotification('error', `Error: ${error.message}`, notificationContainer);
        });
    }

    function showNotification(type, message, container) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : 'spinner fa-spin');
      notification.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        `;
      container.appendChild(notification);

      notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
      });

      if (type !== 'info') {
        setTimeout(() => {
          notification.classList.add('fade-out');
          setTimeout(() => notification.remove(), 300);
        }, 4000);
      }
    }
  });
</script>

{% endblock %}
