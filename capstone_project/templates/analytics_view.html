{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Analytics - Knights of Columbus{% endblock %}

{% block page_title %}Analytics Dashboard{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Analytics</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Dashboard</span>
{% endblock %}

{% block extra_css %}
<style>
  /* Insight Cards */
  .insights-hero {
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    border-radius: 16px;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .insights-hero-text h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 0.25rem;
    color: var(--accent-400);
  }

  .insights-hero-text p {
    opacity: 0.9;
    margin: 0;
    font-size: 0.9rem;
  }

  .engagement-score {
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    text-align: center;
  }

  .engagement-score-value {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
  }

  .engagement-score-label {
    font-size: 0.75rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* KPI Grid */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .kpi-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid #e5e7eb;
    position: relative;
  }

  .kpi-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
  }

  .kpi-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
  }

  .kpi-icon.blue { background: #dbeafe; color: #2563eb; }
  .kpi-icon.green { background: #dcfce7; color: #16a34a; }
  .kpi-icon.amber { background: #fef3c7; color: #d97706; }
  .kpi-icon.purple { background: #f3e8ff; color: #9333ea; }
  .kpi-icon.red { background: #fee2e2; color: #dc2626; }
  .kpi-icon.cyan { background: #cffafe; color: #0891b2; }

  .kpi-trend {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
  }

  .kpi-trend.up { background: #dcfce7; color: #16a34a; }
  .kpi-trend.down { background: #fee2e2; color: #dc2626; }
  .kpi-trend.neutral { background: #f3f4f6; color: #6b7280; }

  .kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .kpi-label {
    font-size: 0.8rem;
    color: #6b7280;
  }

  .kpi-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    margin-top: 0.75rem;
    overflow: hidden;
  }

  .kpi-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .kpi-bar-fill.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
  .kpi-bar-fill.green { background: linear-gradient(90deg, #22c55e, #4ade80); }
  .kpi-bar-fill.amber { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
  .kpi-bar-fill.purple { background: linear-gradient(90deg, #9333ea, #a855f7); }

  /* Insights Row */
  .insights-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1024px) {
    .insights-row { grid-template-columns: 1fr; }
  }

  .insight-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid #e5e7eb;
  }

  .insight-card h4 {
    font-size: 0.8rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .insight-card p {
    font-size: 0.95rem;
    color: #374151;
    line-height: 1.5;
    margin: 0;
  }

  .insight-card .highlight {
    font-weight: 600;
    color: #111827;
  }

  /* Charts Grid */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 1200px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .chart-card--full { grid-column: span 2; }
  @media (max-width: 1200px) { .chart-card--full { grid-column: span 1; } }

  .chart-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f3f4f6;
  }

  .chart-card-header h3 {
    font-size: 0.95rem;
    font-weight: 600;
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-card-header h3 i { color: #2563eb; font-size: 1rem; }

  .chart-card-body {
    padding: 1.25rem;
    height: 280px;
  }

  .chart-summary {
    padding: 0.75rem 1.25rem;
    background: #f9fafb;
    border-top: 1px solid #f3f4f6;
    font-size: 0.8rem;
    color: #6b7280;
  }

  /* Ranking Table */
  .ranking-card { grid-column: span 2; }
  @media (max-width: 1200px) { .ranking-card { grid-column: span 1; } }

  .ranking-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .ranking-table th {
    background: #f9fafb;
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
  }

  .ranking-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    color: #4b5563;
  }

  .ranking-table tr:hover { background: #f9fafb; }

  .rank-badge {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.75rem;
  }

  .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
  .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: white; }
  .rank-3 { background: linear-gradient(135deg, #f97316, #ea580c); color: white; }
  .rank-default { background: #f3f4f6; color: #374151; }

  .score-badge {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 99px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .role-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .role-member { background: #dbeafe; color: #1d4ed8; }
  .role-officer { background: #fef3c7; color: #92400e; }

  /* Blockchain */
  .blockchain-strip {
    background: linear-gradient(135deg, #1e3a8a, #3b82f6);
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    color: white;
  }

  .blockchain-stat {
    text-align: center;
    padding: 0 1rem;
  }

  .blockchain-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  .blockchain-stat-label {
    font-size: 0.7rem;
    opacity: 0.8;
    text-transform: uppercase;
  }

  .chain-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
  }

  .chain-status.valid { background: rgba(34, 197, 94, 0.2); }
  .chain-status.invalid { background: rgba(239, 68, 68, 0.2); }
</style>
{% endblock %}

{% block header_actions %}
<div style="display: flex; align-items: center; gap: 1rem;">
  {% if not is_officer %}
  <form method="get" action="{% url 'analytics_view' %}" style="display: flex; align-items: center; gap: 0.5rem;">
    <label for="council_id" style="font-size: 0.875rem; color: #6b7280;">Council:</label>
    <select name="council_id" id="council_id" onchange="this.form.submit()" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 8px;">
      <option value="">All Councils</option>
      {% for council in councils %}
      <option value="{{ council.id }}" {% if selected_council == council.id|stringformat:"s" %}selected{% endif %}>{{ council.name }}</option>
      {% endfor %}
    </select>
  </form>
  {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- Hero Insight -->
<div class="insights-hero">
  <div class="insights-hero-text">
    <h2>{{ data_summaries.headline|safe }}</h2>
    <p>{{ data_summaries.alert }}</p>
  </div>
  <div class="engagement-score">
    <div class="engagement-score-value">{{ data_summaries.engagement_score }}</div>
    <div class="engagement-score-label">Engagement Score</div>
  </div>
</div>

<!-- KPI Grid -->
<div class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon blue"><i class="fas fa-users"></i></div>
      <span class="kpi-trend {% if data_summaries.participation_rate > 50 %}up{% elif data_summaries.participation_rate > 30 %}neutral{% else %}down{% endif %}">
        {% if data_summaries.participation_rate > 50 %}Good{% elif data_summaries.participation_rate > 30 %}Fair{% else %}Low{% endif %}
      </span>
    </div>
    <div class="kpi-value">{{ data_summaries.participation_rate }}%</div>
    <div class="kpi-label">Participation Rate</div>
    <div class="kpi-bar"><div class="kpi-bar-fill blue" style="width: {{ data_summaries.participation_rate }}%"></div></div>
  </div>

  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon green"><i class="fas fa-hand-holding-usd"></i></div>
      <span class="kpi-trend {% if data_summaries.donation_growth >= 0 %}up{% else %}down{% endif %}">
        {{ data_summaries.donation_trend }}
      </span>
    </div>
    <div class="kpi-value">{{ data_summaries.donation_rate }}%</div>
    <div class="kpi-label">Donor Rate</div>
    <div class="kpi-bar"><div class="kpi-bar-fill green" style="width: {{ data_summaries.donation_rate }}%"></div></div>
  </div>

  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon amber"><i class="fas fa-calendar-check"></i></div>
    </div>
    <div class="kpi-value">{{ data_summaries.avg_events_per_member }}</div>
    <div class="kpi-label">Avg Events per Member</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon purple"><i class="fas fa-chart-line"></i></div>
    </div>
    <div class="kpi-value">{{ data_summaries.avg_attendance_rate }}%</div>
    <div class="kpi-label">Avg Attendance Rate</div>
    <div class="kpi-bar"><div class="kpi-bar-fill purple" style="width: {{ data_summaries.avg_attendance_rate }}%"></div></div>
  </div>

  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon {% if data_summaries.inactive_rate > 30 %}red{% else %}cyan{% endif %}"><i class="fas fa-user-clock"></i></div>
      <span class="kpi-trend {% if data_summaries.inactive_rate > 30 %}down{% elif data_summaries.inactive_rate > 15 %}neutral{% else %}up{% endif %}">
        {{ data_summaries.inactive_count }} members
      </span>
    </div>
    <div class="kpi-value">{{ data_summaries.inactive_rate }}%</div>
    <div class="kpi-label">Inactive Rate</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-card-header">
      <div class="kpi-icon blue"><i class="fas fa-trophy"></i></div>
    </div>
    <div class="kpi-value">{{ data_summaries.highest_role }}s</div>
    <div class="kpi-label">Top Donor Group ({{ data_summaries.role_percentages|dictsort:0|last|last }}%)</div>
  </div>
</div>

<!-- Narrative Insights -->
<div class="insights-row">
  <div class="insight-card">
    <h4><i class="fas fa-user-check" style="color: #2563eb;"></i> Participation</h4>
    <p>{{ data_summaries.participation_insight }}</p>
  </div>
  <div class="insight-card">
    <h4><i class="fas fa-donate" style="color: #22c55e;"></i> Donations</h4>
    <p>{{ data_summaries.donation_insight }} Non-member donations represent {{ data_summaries.non_member_donation_percentage|default:"0" }}% of total contributions.</p>
  </div>
  <div class="insight-card">
    <h4><i class="fas fa-star" style="color: #f59e0b;"></i> Top Performers</h4>
    <p>{{ data_summaries.activity_insight }}</p>
  </div>
</div>

<!-- Blockchain Strip -->
<div class="blockchain-strip">
  <div class="blockchain-stat">
    <div class="blockchain-stat-value">{{ blockchain_metrics.total_blocks }}</div>
    <div class="blockchain-stat-label">Blocks</div>
  </div>
  <div class="blockchain-stat">
    <div class="blockchain-stat-value">{{ blockchain_metrics.total_transactions }}</div>
    <div class="blockchain-stat-label">Transactions</div>
  </div>
  <div class="blockchain-stat">
    <div class="blockchain-stat-value" style="font-size: 0.9rem;">{{ blockchain_metrics.last_block_time }}</div>
    <div class="blockchain-stat-label">Last Block</div>
  </div>
  <div class="chain-status {% if blockchain_metrics.chain_valid %}valid{% else %}invalid{% endif %}">
    <i class="fas {% if blockchain_metrics.chain_valid %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
    <span>{% if blockchain_metrics.chain_valid %}Chain Valid{% else %}Chain Invalid{% endif %}</span>
  </div>
</div>

<!-- Charts -->
<div class="charts-grid">
  <div class="chart-card chart-card--full">
    <div class="chart-card-header">
      <h3><i class="fas fa-user-check"></i> Event Participation</h3>
      <span style="font-size: 0.75rem; color: #6b7280;">Best: {{ data_summaries.best_event }}</span>
    </div>
    <div class="chart-card-body">
      <canvas id="eventParticipationChart"></canvas>
    </div>
  </div>

  <div class="chart-card chart-card--full">
    <div class="chart-card-header">
      <h3><i class="fas fa-chart-line"></i> Donation Forecast</h3>
      <span style="font-size: 0.75rem; color: #6b7280;">
        {% if data_summaries.yoy_growth %}YoY: {{ data_summaries.yoy_growth }}%{% endif %}
      </span>
    </div>
    <div class="chart-card-body">
      <canvas id="predictiveChart"></canvas>
    </div>
    <div class="chart-summary">
      <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
      Dashed line shows 6-month forecast • Solid line is historical data
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-users"></i> Donations by Role</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="donationByRoleChart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-wallet"></i> Payment Methods</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="donationSourcesChart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-chart-pie"></i> Event Types</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="eventTypesChart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-calendar-alt"></i> Events by Council</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="eventsChart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-users"></i> Members & Officers</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="membersOfficersChart"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="chart-card-header">
      <h3><i class="fas fa-graduation-cap"></i> Member Degrees</h3>
    </div>
    <div class="chart-card-body">
      <canvas id="degreeDistributionChart"></canvas>
    </div>
  </div>
</div>

<!-- Activity Ranking -->
<div class="chart-card ranking-card">
  <div class="chart-card-header">
    <h3><i class="fas fa-trophy"></i> Activity Ranking (Top 20)</h3>
  </div>
  <div style="overflow-x: auto;">
    <table class="ranking-table">
      <thead>
        <tr>
          <th style="width: 60px;">Rank</th>
          <th>Name</th>
          <th>Role</th>
          <th style="text-align: center;">Events</th>
          <th style="text-align: right;">Donations</th>
          <th style="text-align: center;">Score</th>
        </tr>
      </thead>
      <tbody>
        {% for member in activity_ranking %}
        <tr>
          <td>
            <div class="rank-badge {% if forloop.counter == 1 %}rank-1{% elif forloop.counter == 2 %}rank-2{% elif forloop.counter == 3 %}rank-3{% else %}rank-default{% endif %}">{{ forloop.counter }}</div>
          </td>
          <td><strong>{{ member.name }}</strong></td>
          <td><span class="role-badge role-{{ member.role }}">{{ member.role }}</span></td>
          <td style="text-align: center;">{{ member.events_attended }}</td>
          <td style="text-align: right;">₱{{ member.total_donated|floatformat:0 }}</td>
          <td style="text-align: center;"><span class="score-badge">{{ member.score }}</span></td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align: center; color: #9ca3af; padding: 2rem;">No activity data</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="chart-summary">
    Score = (Events × 10) + (Donations ÷ 100) • Higher score = more engaged member
  </div>
</div>

<!-- Data Scripts -->
<script id="eventsData" type="application/json">{{ events_data | safe }}</script>
<script id="donationsData" type="application/json">{{ donations_data | safe }}</script>
<script id="membersOfficersData" type="application/json">{{ members_officers_data | safe }}</script>
<script id="eventTypesData" type="application/json">{{ event_types_data | safe }}</script>
<script id="eventParticipationData" type="application/json">{{ event_participation_data | safe }}</script>
<script id="predictiveData" type="application/json">{{ predictive_data | safe }}</script>
<script id="donationByRoleData" type="application/json">{{ donation_by_role_data | safe }}</script>
<script id="donationSourcesData" type="application/json">{{ donation_sources_data | safe }}</script>
<script id="degreeDistributionData" type="application/json">{{ degree_distribution_data | safe }}</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Register the datalabels plugin
    Chart.register(ChartDataLabels);

    Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
    Chart.defaults.color = '#64748b';
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    // Disable datalabels globally, enable per-chart
    Chart.defaults.plugins.datalabels = { display: false };

    const colors = {
      primary: '#2563eb',
      secondary: '#f59e0b',
      success: '#22c55e',
      danger: '#ef4444',
      purple: '#9333ea',
      cyan: '#0891b2'
    };

    // Helper: Calculate percentage
    const calcPercent = (value, dataset) => {
      const total = dataset.reduce((a, b) => a + b, 0);
      return total > 0 ? Math.round((value / total) * 100) : 0;
    };

    // Helper: Format currency
    const formatCurrency = (val) => '₱' + val.toLocaleString();

    const eventsData = JSON.parse(document.getElementById('eventsData')?.textContent || '{}');
    const membersOfficersData = JSON.parse(document.getElementById('membersOfficersData')?.textContent || '{}');
    const eventTypesData = JSON.parse(document.getElementById('eventTypesData')?.textContent || '{}');
    const eventParticipationData = JSON.parse(document.getElementById('eventParticipationData')?.textContent || '{}');
    const predictiveData = JSON.parse(document.getElementById('predictiveData')?.textContent || '{}');
    const donationByRoleData = JSON.parse(document.getElementById('donationByRoleData')?.textContent || '{}');
    const donationSourcesData = JSON.parse(document.getElementById('donationSourcesData')?.textContent || '{}');
    const degreeDistributionData = JSON.parse(document.getElementById('degreeDistributionData')?.textContent || '{}');

    // Payment Methods Chart (GCash vs Manual) - WITH PERCENTAGES
    if (donationSourcesData.labels?.length) {
      new Chart(document.getElementById('donationSourcesChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: donationSourcesData.labels,
          datasets: [{
            data: donationSourcesData.data,
            backgroundColor: [colors.primary, colors.success],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const pct = calcPercent(ctx.raw, ctx.dataset.data);
                  return `${ctx.label}: ${formatCurrency(ctx.raw)} (${pct}%)`;
                }
              }
            },
            datalabels: {
              display: true,
              color: '#fff',
              font: { weight: 'bold', size: 13 },
              formatter: (value, ctx) => {
                const pct = calcPercent(value, ctx.dataset.data);
                return pct > 5 ? pct + '%' : '';
              }
            }
          }
        }
      });
    }

    // Member Degree Distribution Chart - WITH PERCENTAGES
    if (degreeDistributionData.labels?.length) {
      const degreeTotal = degreeDistributionData.data.reduce((a, b) => a + b, 0);
      new Chart(document.getElementById('degreeDistributionChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: degreeDistributionData.labels,
          datasets: [{
            label: 'Members',
            data: degreeDistributionData.data,
            backgroundColor: [colors.primary, colors.secondary, colors.success, colors.purple, '#94a3b8'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',  // Horizontal bar for better readability
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const pct = degreeTotal > 0 ? Math.round((ctx.raw / degreeTotal) * 100) : 0;
                  return `${ctx.raw} members (${pct}% of total)`;
                }
              }
            },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'end',
              color: '#374151',
              font: { weight: '600', size: 11 },
              formatter: (value) => {
                const pct = degreeTotal > 0 ? Math.round((value / degreeTotal) * 100) : 0;
                return `${value} (${pct}%)`;
              }
            }
          },
          scales: {
            x: { beginAtZero: true, grid: { display: false } },
            y: { grid: { display: false } }
          }
        }
      });
    }

    // Event Participation - WITH ATTENDANCE RATE PERCENTAGES
    if (eventParticipationData.labels?.length) {
      new Chart(document.getElementById('eventParticipationChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: eventParticipationData.labels,
          datasets: [
            { label: 'Attended', data: eventParticipationData.attended, backgroundColor: colors.success, borderRadius: 4 },
            { label: 'Did Not Attend', data: eventParticipationData.not_attended, backgroundColor: '#e5e7eb', borderRadius: 4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                afterBody: (ctx) => {
                  const idx = ctx[0].dataIndex;
                  const attended = eventParticipationData.attended[idx];
                  const notAttended = eventParticipationData.not_attended[idx];
                  const total = attended + notAttended;
                  const rate = total > 0 ? Math.round((attended / total) * 100) : 0;
                  return `\nAttendance Rate: ${rate}%`;
                }
              }
            },
            datalabels: {
              display: (ctx) => ctx.datasetIndex === 0, // Only show on "Attended" bars
              anchor: 'center',
              align: 'center',
              color: '#fff',
              font: { weight: 'bold', size: 11 },
              formatter: (value, ctx) => {
                const idx = ctx.dataIndex;
                const attended = eventParticipationData.attended[idx];
                const notAttended = eventParticipationData.not_attended[idx];
                const total = attended + notAttended;
                const rate = total > 0 ? Math.round((attended / total) * 100) : 0;
                return rate > 0 ? rate + '%' : '';
              }
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false } },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Number of Members' } }
          }
        }
      });
    }

    // Predictive Chart - WITH VALUE LABELS ON POINTS
    if (predictiveData.historical_labels?.length || predictiveData.forecast_labels?.length) {
      const allLabels = [...(predictiveData.historical_labels || []), ...(predictiveData.forecast_labels || [])];
      const historicalData = [...(predictiveData.historical_data || []), ...Array(predictiveData.forecast_labels?.length || 0).fill(null)];

      const lastHistoricalValue = predictiveData.historical_data?.length ? predictiveData.historical_data[predictiveData.historical_data.length - 1] : null;
      const forecastData = [...Array(Math.max(0, (predictiveData.historical_data?.length || 0) - 1)).fill(null), lastHistoricalValue, ...(predictiveData.forecast_data || [])];

      new Chart(document.getElementById('predictiveChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: allLabels,
          datasets: [
            { label: 'Historical', data: historicalData, borderColor: colors.primary, backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 },
            { label: 'Forecast', data: forecastData, borderColor: colors.secondary, borderDash: [5, 5], backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.4, pointRadius: 5, pointHoverRadius: 7 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.raw !== null ? `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}` : ''
              }
            },
            datalabels: {
              display: (ctx) => ctx.raw !== null && (ctx.dataIndex === 0 || ctx.dataIndex === ctx.dataset.data.filter(v => v !== null).length - 1),
              anchor: 'end',
              align: 'top',
              color: '#374151',
              font: { weight: '600', size: 10 },
              formatter: (value) => value !== null ? formatCurrency(value) : ''
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: (val) => '₱' + val.toLocaleString() }
            }
          }
        }
      });
    }

    // Donation by Role - WITH PERCENTAGES
    if (donationByRoleData.labels?.length) {
      new Chart(document.getElementById('donationByRoleChart').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: donationByRoleData.labels,
          datasets: [{
            data: donationByRoleData.data,
            backgroundColor: [colors.primary, colors.secondary, colors.purple, colors.success],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const pct = calcPercent(ctx.raw, ctx.dataset.data);
                  return `${ctx.label}: ${formatCurrency(ctx.raw)} (${pct}%)`;
                }
              }
            },
            datalabels: {
              display: true,
              color: '#fff',
              font: { weight: 'bold', size: 13 },
              formatter: (value, ctx) => {
                const pct = calcPercent(value, ctx.dataset.data);
                return pct > 5 ? pct + '%' : '';
              }
            }
          }
        }
      });
    }

    // Event Types - WITH PERCENTAGES
    if (eventTypesData.labels?.length) {
      const validCategories = ['Exemplification', 'Service Program', 'Council Meeting', 'Assembly Meeting'];
      const filteredLabels = eventTypesData.labels.filter(label => validCategories.includes(label));
      const filteredData = eventTypesData.data.filter((_, index) => validCategories.includes(eventTypesData.labels[index]));

      if (filteredLabels.length > 0) {
        new Chart(document.getElementById('eventTypesChart').getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: filteredLabels,
            datasets: [{
              data: filteredData,
              backgroundColor: [colors.primary, colors.secondary, colors.success, colors.purple],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const pct = calcPercent(ctx.raw, ctx.dataset.data);
                    return `${ctx.label}: ${ctx.raw} events (${pct}%)`;
                  }
                }
              },
              datalabels: {
                display: true,
                color: '#fff',
                font: { weight: 'bold', size: 13 },
                formatter: (value, ctx) => {
                  const pct = calcPercent(value, ctx.dataset.data);
                  return pct > 5 ? pct + '%' : '';
                }
              }
            }
          }
        });
      }
    }

    // Events Chart - WITH COUNT LABELS
    if (eventsData.labels?.length) {
      new Chart(document.getElementById('eventsChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: eventsData.labels,
          datasets: [{
            label: 'Events',
            data: eventsData.data,
            backgroundColor: colors.primary,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'end',
              color: '#374151',
              font: { weight: '600', size: 11 },
              formatter: (value) => value > 0 ? value : ''
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Members/Officers - WITH COUNT + PERCENTAGE LABELS
    if (membersOfficersData.labels?.length) {
      new Chart(document.getElementById('membersOfficersChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: membersOfficersData.labels,
          datasets: [
            { label: 'Members', data: membersOfficersData.members, backgroundColor: colors.primary, borderRadius: 4 },
            { label: 'Officers', data: membersOfficersData.officers, backgroundColor: colors.secondary, borderRadius: 4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                afterBody: (ctx) => {
                  const idx = ctx[0].dataIndex;
                  const members = membersOfficersData.members[idx] || 0;
                  const officers = membersOfficersData.officers[idx] || 0;
                  const total = members + officers;
                  return `\nTotal: ${total} users`;
                }
              }
            },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'end',
              color: '#374151',
              font: { weight: '600', size: 10 },
              formatter: (value) => value > 0 ? value : ''
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { grid: { display: false } }
          }
        }
      });
    }
  });
</script>
{% endblock %}
