{% extends 'dashboard_base.html' %}
{% load static %}
{% block title %}Manage Councils{% endblock %}
{% block page_title %}Manage Councils{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Management</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Manage Councils</span>
{% endblock %}

{% block header_actions %}
<button class="btn btn--primary" onclick="openAddCouncilModal()">
  <i class="fas fa-plus"></i> Add Council
</button>
{% endblock %}

{% block extra_css %}
<style>
  .councils-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--neutral-100);
  }

  .search-box {
    position: relative;
    width: 280px;
  }

  .search-box input {
    width: 100%;
    padding: var(--space-2) var(--space-4);
    padding-left: var(--space-9);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .search-box i {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--neutral-400);
  }

  .count-badge {
    background: var(--primary-100);
    color: var(--primary-700);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
  }

  .councils-table {
    width: 100%;
    border-collapse: collapse;
  }

  .councils-table thead {
    background: var(--neutral-50);
  }

  .councils-table th {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--neutral-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--neutral-200);
  }

  .councils-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--neutral-100);
    font-size: var(--text-sm);
    color: var(--neutral-700);
  }

  .councils-table tbody tr {
    transition: background var(--transition-fast);
  }

  .councils-table tbody tr:hover {
    background: var(--neutral-50);
  }

  .council-name {
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
  }

  .location-text {
    color: var(--neutral-500);
    font-size: var(--text-sm);
  }

  .member-count {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-1) var(--space-3);
    background: var(--primary-50);
    color: var(--primary-700);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
  }

  .action-buttons {
    display: flex;
    gap: var(--space-2);
    justify-content: center;
  }

  .action-btn {
    padding: var(--space-2) var(--space-3);
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .action-btn.edit {
    background: var(--info-50);
    color: var(--info-700);
  }

  .action-btn.edit:hover {
    background: var(--info-100);
  }

  .action-btn.delete {
    background: var(--error-50);
    color: var(--error-700);
  }

  .action-btn.delete:hover {
    background: var(--error-100);
  }

  .empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--neutral-400);
  }

  .empty-state i {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-3);
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius-2xl);
    max-width: 560px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal-header {
    padding: var(--space-5);
    border-bottom: 1px solid var(--neutral-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h3 {
    margin: 0;
    font-size: var(--text-lg);
    color: var(--neutral-900);
  }

  .modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--neutral-100);
    border-radius: var(--radius-full);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-lg);
    color: var(--neutral-600);
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--neutral-200);
  }

  .modal-body {
    padding: var(--space-5);
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--neutral-700);
  }

  .form-group input,
  .form-group select {
    padding: var(--space-3);
    border: 1px solid var(--neutral-200);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .modal-footer {
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--neutral-100);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
  }

  .warning-message {
    padding: var(--space-4);
    background: var(--warning-50);
    border: 1px solid var(--warning-200);
    border-radius: var(--radius-lg);
    color: var(--warning-700);
    text-align: center;
  }

  .warning-message i {
    font-size: var(--text-2xl);
    color: var(--warning-500);
    margin-bottom: var(--space-2);
  }

  .warning-text {
    color: var(--error-600);
    font-size: var(--text-sm);
  }

  @media (max-width: 768px) {
    .councils-header {
      flex-direction: column;
      gap: var(--space-3);
    }

    .search-box {
      width: 100%;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-card">
  <div class="councils-header">
    <div class="search-box">
      <!-- <i class="fas fa-search"></i> -->
      <input type="text" id="councilSearchInput" placeholder=" Search councils...">
    </div>
    <span class="count-badge">{{ council_data|length }} Councils</span>
  </div>
  <div class="dashboard-card-body" style="padding: 0;">
    <table class="councils-table">
      <thead>
        <tr>
          <th>Council Name</th>
          <th>Location</th>
          <th>Members</th>
          <th style="text-align: center;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for data in council_data %}
        <tr data-name="{{ data.council.name }}">
          <td><span class="council-name">{{ data.council.name }}</span></td>
          <td>
            {% if data.council.location_city %}
            <span>{{ data.council.location_city }}, {{ data.council.location_province }}</span>
            {% else %}
            <span class="location-text">Not set</span>
            {% endif %}
          </td>
          <td><span class="member-count"><i class="fas fa-users"></i> {{ data.member_count }}</span></td>
          <td>
            <div class="action-buttons">
              <button class="action-btn edit"
                onclick="openEditCouncilModal({{ data.council.pk }}, '{{ data.council.name|escapejs }}', '{{ data.council.location_street|escapejs }}', '{{ data.council.location_barangay|escapejs }}', '{{ data.council.location_city|escapejs }}', '{{ data.council.location_province|escapejs }}', '{{ data.council.location_zip_code|escapejs }}')">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="action-btn delete"
                onclick="confirmDeleteCouncil({{ data.council.pk }}, '{{ data.council.name|escapejs }}', {{ data.member_count }})">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4">
            <div class="empty-state">
              <i class="fas fa-building"></i>
              <p>No councils found. Add your first council!</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Add Council Modal -->
<div id="addCouncilModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-plus-circle"></i> Add New Council</h3>
      <button class="modal-close" onclick="closeAddCouncilModal()">&times;</button>
    </div>
    <form method="POST" action="{% url 'add_council' %}">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="council_name">Council Name</label>
            <input type="text" id="council_name" name="council_name" placeholder="Enter council name" required>
          </div>
          <div class="form-group full-width">
            <label for="add_province">Province</label>
            <select id="add_province" name="location_province" onchange="loadAddCities()">
              <option value="">-- Select Province --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add_city">City/Municipality</label>
            <select id="add_city" name="location_city" onchange="loadAddBarangays(); updateAddZipCode()" disabled>
              <option value="">-- Select City --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add_barangay">Barangay</label>
            <select id="add_barangay" name="location_barangay" disabled>
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="add_zip_code">ZIP Code</label>
            <input type="text" id="add_zip_code" name="location_zip_code" placeholder="Auto-filled" readonly>
          </div>
          <div class="form-group">
            <label for="location_street">Street Address</label>
            <input type="text" id="location_street" name="location_street" placeholder="Street (optional)">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeAddCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Add Council</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Council Modal -->
<div id="editCouncilModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Edit Council</h3>
      <button class="modal-close" onclick="closeEditCouncilModal()">&times;</button>
    </div>
    <form method="POST" id="editCouncilForm">
      {% csrf_token %}
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="edit_council_name">Council Name</label>
            <input type="text" id="edit_council_name" name="council_name" required>
          </div>
          <div class="form-group full-width">
            <label for="edit_province">Province</label>
            <select id="edit_province" name="location_province" onchange="loadEditCities()">
              <option value="">-- Select Province --</option>
              <option value="Batangas">Batangas</option>
              <option value="Cavite">Cavite</option>
              <option value="Laguna">Laguna</option>
              <option value="Quezon">Quezon</option>
              <option value="Rizal">Rizal</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit_city">City/Municipality</label>
            <select id="edit_city" name="location_city" onchange="loadEditBarangays(); updateEditZipCode()" disabled>
              <option value="">-- Select City --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit_barangay">Barangay</label>
            <select id="edit_barangay" name="location_barangay" disabled>
              <option value="">-- Select Barangay --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit_zip_code">ZIP Code</label>
            <input type="text" id="edit_zip_code" name="location_zip_code" readonly>
          </div>
          <div class="form-group">
            <label for="edit_location_street">Street Address</label>
            <input type="text" id="edit_location_street" name="location_street" placeholder="Street (optional)">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn--ghost" onclick="closeEditCouncilModal()">Cancel</button>
        <button type="submit" class="btn btn--primary">Update Council</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteCouncilModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle" style="color: var(--error-500);"></i> Confirm Delete</h3>
      <button class="modal-close" onclick="closeDeleteCouncilModal()">&times;</button>
    </div>
    <div class="modal-body" id="deleteCouncilContent">
      <p>Are you sure you want to delete this council?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn--ghost" onclick="closeDeleteCouncilModal()">Cancel</button>
      <form method="POST" id="deleteCouncilForm" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn--error">Delete</button>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('councilSearchInput');
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.councils-table tbody tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });
});

function openAddCouncilModal() {
  const modal = document.getElementById('addCouncilModal');
  modal.style.display = 'flex';
  modal.classList.add('show');
}

function closeAddCouncilModal() {
  const modal = document.getElementById('addCouncilModal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

function openEditCouncilModal(councilId, councilName, locationStreet, locationBarangay, locationCity, locationProvince, locationZipCode) {
  const modal = document.getElementById('editCouncilModal');
  const form = document.getElementById('editCouncilForm');

  form.action = `/edit-council/${councilId}/`;
  document.getElementById('edit_council_name').value = councilName;
  document.getElementById('edit_location_street').value = locationStreet || '';

  const provinceSelect = document.getElementById('edit_province');
  provinceSelect.value = locationProvince || '';

  if (locationProvince) {
    loadEditCities();
    setTimeout(() => {
      document.getElementById('edit_city').value = locationCity || '';
      if (locationCity) {
        loadEditBarangays();
        setTimeout(() => {
          document.getElementById('edit_barangay').value = locationBarangay || '';
          updateEditZipCode();
        }, 100);
      }
    }, 100);
  }

  modal.style.display = 'flex';
  modal.classList.add('show');
}

function closeEditCouncilModal() {
  const modal = document.getElementById('editCouncilModal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

function confirmDeleteCouncil(councilId, councilName, memberCount) {
  const modal = document.getElementById('deleteCouncilModal');
  const content = document.getElementById('deleteCouncilContent');
  const form = document.getElementById('deleteCouncilForm');

  if (memberCount > 0) {
    content.innerHTML = `
      <div class="warning-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Cannot delete "<strong>${councilName}</strong>" because it has <strong>${memberCount}</strong> active member(s).</p>
        <p style="margin-top: var(--space-2); font-size: var(--text-sm);">Please reassign members to another council first.</p>
      </div>
    `;
    form.style.display = 'none';
  } else {
    content.innerHTML = `
      <p>Are you sure you want to delete "<strong>${councilName}</strong>"?</p>
      <p class="warning-text">This action cannot be undone.</p>
    `;
    form.action = `/delete-council/${councilId}/`;
    form.style.display = 'inline';
  }

  modal.style.display = 'flex';
  modal.classList.add('show');
}

function closeDeleteCouncilModal() {
  const modal = document.getElementById('deleteCouncilModal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = 'none', 300);
}

window.addEventListener('click', function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.classList.remove('show');
    setTimeout(() => event.target.style.display = 'none', 300);
  }
});

// CALABARZON Location Data
const locationData = {
  "Batangas": {
    "Batangas City": { "zip": "4200", "barangays": ["Alangilan", "Balagtas", "Balete", "Banaba Center", "Bilogo", "Bolbok", "Bukal", "Calicanto", "Concepcion", "Cuta", "Dalig", "Dumantay"] },
    "Lipa City": { "zip": "4217", "barangays": ["Adya", "Anilao", "Balele", "Bolbok", "Canlubang", "Halang", "Marauoy", "Mataas Na Lupa", "Poblacion"] },
    "Tanauan City": { "zip": "4232", "barangays": ["Altura Bata", "Ambulong", "Boot", "Cale", "Darasa", "Gonzales", "Laurel", "Mabini", "Natatas", "Poblacion"] }
  },
  "Cavite": {
    "Bacoor": { "zip": "4102", "barangays": ["Alima", "Aniban I", "Bayanan", "Habay I", "Mabolo I", "Molino I", "Niog I", "Salinas I", "Talaba I", "Zapote I"] },
    "Dasmariñas": { "zip": "4114", "barangays": ["Burol I", "Langkaan I", "Paliparan I", "Sabang", "Salawag", "Salitran I", "San Agustin I", "San Jose", "Santa Fe"] },
    "Tagaytay": { "zip": "4120", "barangays": ["Asisan", "Bagong Tubig", "Francisco", "Iruhin East", "Kaybagal", "Maharlika", "Neogan", "San Jose", "Sungay"] }
  },
  "Laguna": {
    "Calamba": { "zip": "4027", "barangays": ["Bagong Kalsada", "Banadero", "Canlubang", "Halang", "Makiling", "Mayapa", "Pansol", "Real", "Turbina"] },
    "San Pablo": { "zip": "4000", "barangays": ["Concepcion", "Dolores", "San Antonio", "San Jose", "San Lucas", "San Roque", "Santa Cruz", "Santo Niño"] },
    "Santa Rosa": { "zip": "4026", "barangays": ["Aplaya", "Balibago", "Dila", "Ibaba", "Macabling", "Market Area", "Santo Domingo", "Tagapo"] }
  },
  "Quezon": {
    "Lucena": { "zip": "4301", "barangays": ["Barangay 1", "Barra", "Cotta", "Dalahican", "Ibabang Dupay", "Isabang", "Market View", "Ransohan"] },
    "Tayabas": { "zip": "4327", "barangays": ["Alitao", "Angeles", "Baguio", "Calumpang", "Gibanga", "Poblacion", "San Diego", "Tamlong"] }
  },
  "Rizal": {
    "Antipolo": { "zip": "1870", "barangays": ["Beverly Hills", "Cupang", "Dela Paz", "Mambugan", "Mayamot", "San Isidro", "San Jose", "San Roque"] },
    "Cainta": { "zip": "1900", "barangays": ["San Andres", "San Isidro", "San Juan", "San Roque", "Santa Rosa", "Santo Domingo", "Santo Niño"] },
    "Taytay": { "zip": "1920", "barangays": ["Dolores", "Muzon", "San Isidro", "San Juan", "Santa Ana", "Tatlong Kawayan"] }
  }
};

function loadAddCities() {
  const province = document.getElementById('add_province').value;
  const citySelect = document.getElementById('add_city');
  const barangaySelect = document.getElementById('add_barangay');

  citySelect.innerHTML = '<option value="">-- Select City --</option>';
  barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
  barangaySelect.disabled = true;

  if (province && locationData[province]) {
    citySelect.disabled = false;
    Object.keys(locationData[province]).forEach(city => {
      const option = document.createElement('option');
      option.value = city;
      option.textContent = city;
      citySelect.appendChild(option);
    });
  } else {
    citySelect.disabled = true;
  }
}

function loadAddBarangays() {
  const province = document.getElementById('add_province').value;
  const city = document.getElementById('add_city').value;
  const barangaySelect = document.getElementById('add_barangay');

  barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';

  if (province && city && locationData[province] && locationData[province][city]) {
    barangaySelect.disabled = false;
    locationData[province][city].barangays.forEach(brgy => {
      const option = document.createElement('option');
      option.value = brgy;
      option.textContent = brgy;
      barangaySelect.appendChild(option);
    });
  } else {
    barangaySelect.disabled = true;
  }
}

function updateAddZipCode() {
  const province = document.getElementById('add_province').value;
  const city = document.getElementById('add_city').value;
  const zipInput = document.getElementById('add_zip_code');

  if (province && city && locationData[province] && locationData[province][city]) {
    zipInput.value = locationData[province][city].zip;
  } else {
    zipInput.value = '';
  }
}

function loadEditCities() {
  const province = document.getElementById('edit_province').value;
  const citySelect = document.getElementById('edit_city');
  const barangaySelect = document.getElementById('edit_barangay');

  citySelect.innerHTML = '<option value="">-- Select City --</option>';
  barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
  barangaySelect.disabled = true;

  if (province && locationData[province]) {
    citySelect.disabled = false;
    Object.keys(locationData[province]).forEach(city => {
      const option = document.createElement('option');
      option.value = city;
      option.textContent = city;
      citySelect.appendChild(option);
    });
  } else {
    citySelect.disabled = true;
  }
}

function loadEditBarangays() {
  const province = document.getElementById('edit_province').value;
  const city = document.getElementById('edit_city').value;
  const barangaySelect = document.getElementById('edit_barangay');

  barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';

  if (province && city && locationData[province] && locationData[province][city]) {
    barangaySelect.disabled = false;
    locationData[province][city].barangays.forEach(brgy => {
      const option = document.createElement('option');
      option.value = brgy;
      option.textContent = brgy;
      barangaySelect.appendChild(option);
    });
  } else {
    barangaySelect.disabled = true;
  }
}

function updateEditZipCode() {
  const province = document.getElementById('edit_province').value;
  const city = document.getElementById('edit_city').value;
  const zipInput = document.getElementById('edit_zip_code');

  if (province && city && locationData[province] && locationData[province][city]) {
    zipInput.value = locationData[province][city].zip;
  } else {
    zipInput.value = '';
  }
}
</script>
{% endblock %}
