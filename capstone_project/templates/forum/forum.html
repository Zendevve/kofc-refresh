{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Community Forum - Knights of Columbus{% endblock %}

{% block page_title %}Community Forum{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Community</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Forum</span>
{% endblock %}

{% block extra_css %}
<style>
  /* Forum Layout */
  .forum-layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.5rem;
    min-height: calc(100vh - 200px);
  }

  @media (max-width: 1024px) {
    .forum-layout {
      grid-template-columns: 1fr;
    }
    .forum-sidebar-panel {
      display: none;
    }
  }

  /* Forum Type Tabs */
  .forum-type-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .forum-type-tab {
    padding: 0.5rem 1.25rem;
    border-radius: 99px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid #e5e7eb;
    background: white;
    color: #6b7280;
    transition: all 0.2s ease;
  }

  .forum-type-tab:hover {
    border-color: #2563eb;
    color: #2563eb;
  }

  .forum-type-tab.active {
    background: #2563eb;
    border-color: #2563eb;
    color: white;
  }

  /* Category Tabs */
  .category-tabs {
    display: flex;
    gap: 0.25rem;
    padding: 0.25rem;
    background: #f3f4f6;
    border-radius: 10px;
    margin-bottom: 1rem;
    overflow-x: auto;
  }

  .category-tab {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: transparent;
    color: #6b7280;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .category-tab:hover {
    background: #e5e7eb;
    color: #374151;
  }

  .category-tab.active {
    background: white;
    color: #2563eb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Search Bar */
  .forum-search {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .forum-search input {
    flex: 1;
    padding: 0.625rem 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
  }

  .forum-search input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  .search-btn {
    padding: 0.625rem 1rem;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
  }

  .search-btn:hover {
    background: #1d4ed8;
  }

  .search-btn.clear {
    background: #ef4444;
    display: none;
  }

  .search-btn.clear.visible {
    display: block;
  }

  /* Messages Container */
  .messages-panel {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 280px);
    min-height: 400px;
  }

  .messages-list {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .messages-list::-webkit-scrollbar {
    width: 6px;
  }

  .messages-list::-webkit-scrollbar-track {
    background: #f3f4f6;
  }

  .messages-list::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 3px;
  }

  /* Message Card */
  .message-card {
    background: #f9fafb;
    border-radius: 10px;
    padding: 1rem;
    position: relative;
    transition: all 0.2s ease;
    border: 1px solid transparent;
  }

  .message-card:hover {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }

  .message-card.own {
    background: #eff6ff;
    border-left: 3px solid #2563eb;
  }

  .message-card.pinned {
    border: 1px solid #fbbf24;
    background: #fffbeb;
  }

  .message-card.sending {
    opacity: 0.6;
  }

  .message-card.new {
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .message-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: #e5e7eb;
  }

  .message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .message-avatar .initials {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
  }

  .message-meta {
    flex: 1;
    min-width: 0;
  }

  .message-sender {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .sender-name {
    font-weight: 600;
    color: #111827;
    font-size: 0.875rem;
  }

  .sender-role {
    font-size: 0.7rem;
    padding: 0.15rem 0.5rem;
    border-radius: 99px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .role-admin {
    background: #fef3c7;
    color: #92400e;
  }

  .role-officer {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .role-member {
    background: #dcfce7;
    color: #166534;
  }

  .message-time {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .message-content {
    color: #374151;
    font-size: 0.9rem;
    line-height: 1.5;
    word-break: break-word;
  }

  .message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 0.75rem;
    cursor: pointer;
  }

  .message-actions-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .message-card:hover .message-actions-btn {
    opacity: 1;
  }

  .action-trigger {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    background: white;
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s;
  }

  .action-trigger:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .action-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 140px;
    z-index: 50;
    display: none;
    overflow: hidden;
  }

  .action-menu.show {
    display: block;
  }

  .action-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    font-size: 0.8rem;
    color: #374151;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    transition: background 0.15s;
  }

  .action-item:hover {
    background: #f3f4f6;
  }

  .action-item.delete {
    color: #dc2626;
  }

  .action-item i {
    width: 16px;
    text-align: center;
  }

  /* Pin Badge */
  .pin-badge {
    position: absolute;
    top: -6px;
    right: 12px;
    background: #fbbf24;
    color: #78350f;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    transform: rotate(45deg);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  }

  /* Message Input */
  .message-input-area {
    padding: 1rem;
    border-top: 1px solid #f3f4f6;
    background: #f9fafb;
    border-radius: 0 0 12px 12px;
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
    align-items: flex-end;
  }

  .upload-btn {
    width: 42px;
    height: 42px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .upload-btn:hover {
    border-color: #2563eb;
    color: #2563eb;
  }

  .message-textarea {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    resize: none;
    min-height: 42px;
    max-height: 120px;
    font-family: inherit;
    background: white;
  }

  .message-textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  .send-btn {
    padding: 0.75rem 1.25rem;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.2s;
    flex-shrink: 0;
  }

  .send-btn:hover {
    background: #1d4ed8;
  }

  .send-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  /* Image Preview */
  .image-preview-container {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    display: none;
    align-items: center;
    gap: 0.75rem;
  }

  .image-preview-container.visible {
    display: flex;
  }

  .image-preview-container img {
    max-height: 60px;
    max-width: 100px;
    border-radius: 6px;
    object-fit: cover;
  }

  .image-preview-container .filename {
    flex: 1;
    font-size: 0.8rem;
    color: #6b7280;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .image-preview-container .remove-btn {
    padding: 0.375rem 0.75rem;
    border: none;
    border-radius: 6px;
    background: #fee2e2;
    color: #dc2626;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .image-error-msg {
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: #fee2e2;
    color: #dc2626;
    border-radius: 6px;
    font-size: 0.8rem;
    display: none;
  }

  .image-error-msg.visible {
    display: block;
  }

  /* Sidebar Panel */
  .forum-sidebar-panel {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .sidebar-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
  }

  .sidebar-card-header {
    padding: 0.875rem 1rem;
    background: #f9fafb;
    border-bottom: 1px solid #f3f4f6;
    font-weight: 600;
    font-size: 0.875rem;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sidebar-card-header i {
    color: #fbbf24;
  }

  .sidebar-card-body {
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
  }

  .pinned-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background 0.15s;
  }

  .pinned-item:last-child {
    border-bottom: none;
  }

  .pinned-item:hover {
    background: #f9fafb;
  }

  .pinned-item-sender {
    font-weight: 600;
    font-size: 0.8rem;
    color: #111827;
    margin-bottom: 0.25rem;
  }

  .pinned-item-preview {
    font-size: 0.8rem;
    color: #6b7280;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .pinned-item-time {
    font-size: 0.7rem;
    color: #9ca3af;
    margin-top: 0.25rem;
  }

  .empty-pinned {
    padding: 1.5rem 1rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.8rem;
  }

  /* User Card */
  .user-sidebar-card {
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-sidebar-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    overflow: hidden;
    background: #e5e7eb;
  }

  .user-sidebar-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .user-sidebar-info h4 {
    font-weight: 600;
    font-size: 0.9rem;
    color: #111827;
    margin: 0 0 0.25rem;
  }

  .user-sidebar-info span {
    font-size: 0.8rem;
    color: #6b7280;
  }

  /* Jump to Present */
  .jump-to-present {
    position: fixed;
    bottom: 100px;
    right: 40px;
    background: #2563eb;
    color: white;
    padding: 0.625rem 1rem;
    border-radius: 99px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(37,99,235,0.3);
    display: none;
    align-items: center;
    gap: 0.5rem;
    z-index: 100;
    transition: transform 0.2s;
  }

  .jump-to-present:hover {
    transform: translateY(-2px);
  }

  .jump-to-present.visible {
    display: flex;
  }

  /* No Results */
  .no-results-msg {
    text-align: center;
    padding: 3rem 1rem;
    color: #9ca3af;
    font-size: 0.9rem;
  }

  /* Delete Confirmation */
  .delete-confirm {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    z-index: 60;
    display: none;
    text-align: center;
  }

  .delete-confirm.show {
    display: block;
  }

  .delete-confirm p {
    margin: 0 0 0.75rem;
    font-size: 0.875rem;
    color: #374151;
  }

  .delete-confirm-btns {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .delete-confirm-btns button {
    padding: 0.375rem 0.875rem;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    border: none;
  }

  .btn-confirm-yes {
    background: #dc2626;
    color: white;
  }

  .btn-confirm-no {
    background: #f3f4f6;
    color: #374151;
  }

  /* Copy Notification */
  .copy-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: white;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
  }

  .copy-toast.show {
    opacity: 1;
  }

  /* Animations */
  .message-card.deleting {
    animation: fadeOut 0.4s ease forwards;
  }

  @keyframes fadeOut {
    to { opacity: 0; transform: scale(0.95); }
  }

  .message-card.pinning {
    animation: pinPulse 0.4s ease;
  }

  @keyframes pinPulse {
    50% { transform: scale(1.02); }
  }
</style>
{% endblock %}

{% block header_actions %}
<div class="forum-type-tabs">
  <button class="forum-type-tab active" data-type="council">
    <i class="fas fa-globe"></i> District (Public)
  </button>
  <button class="forum-type-tab" data-type="district">
    <i class="fas fa-lock"></i> Council {{ user_council.id }} (Private)
  </button>
</div>
{% endblock %}

{% block content %}
{% csrf_token %}

<div class="forum-layout">
  <div class="forum-main-area">
    <!-- Category Tabs -->
    <div class="category-tabs" id="categoryTabs">
      {% for category in categories %}
      <button class="category-tab {% if forloop.first %}active{% endif %}" data-id="{{ category.id }}">
        {{ category.get_name_display }}
      </button>
      {% endfor %}
    </div>

    <!-- Search -->
    <div class="forum-search">
      <input type="text" id="searchInput" placeholder="Search messages...">
      <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
      <button class="search-btn clear" id="clearSearchBtn"><i class="fas fa-times"></i></button>
    </div>

    <!-- Messages Panel -->
    <div class="messages-panel">
      <div class="messages-list" id="messagesList">
        <!-- Messages will be loaded here -->
      </div>

      <div class="message-input-area">
        <div class="input-row">
          <label for="imageUpload" class="upload-btn" title="Upload image">
            <i class="fas fa-image"></i>
          </label>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
          <textarea id="messageInput" class="message-textarea" placeholder="Type a message..." rows="1"></textarea>
          <button class="send-btn" id="sendBtn">
            <i class="fas fa-paper-plane"></i> Send
          </button>
        </div>
        <div class="image-preview-container" id="imagePreview">
          <img src="" alt="Preview" id="previewImg">
          <span class="filename" id="previewFilename"></span>
          <button class="remove-btn" id="removeImageBtn">Remove</button>
        </div>
        <div class="image-error-msg" id="imageError">File size exceeds 10MB limit.</div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="forum-sidebar-panel">
    <!-- User Card -->
    <a href="{% url 'edit_profile' %}" class="sidebar-card user-card-link" style="text-decoration: none; display: block;">
      <div class="user-sidebar-card">
        <div class="user-sidebar-avatar">
          {% if current_user.profile_picture %}
          <img src="{{ current_user.profile_picture.url }}" alt="{{ current_user.username }}">
          {% else %}
          <div class="initials" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#2563eb,#3b82f6);color:white;font-weight:600;">{{ current_user.first_name|first }}{{ current_user.last_name|first }}</div>
          {% endif %}
        </div>
        <div class="user-sidebar-info">
          <h4>{{ current_user.first_name }} {{ current_user.last_name }}</h4>
          <span>
            {% if current_user.role == 'admin' %}District Director{% elif current_user.role == 'officer' %}Officer{% else %}Member{% endif %}
            {% if current_user.council %} â€¢ Council {{ current_user.council.id }}{% endif %}
          </span>
        </div>
        <i class="fas fa-chevron-right" style="color: #9ca3af; margin-left: auto;"></i>
      </div>
    </a>

    <!-- Pinned Messages -->
    <div class="sidebar-card">
      <div class="sidebar-card-header">
        <i class="fas fa-thumbtack"></i> Pinned Messages
      </div>
      <div class="sidebar-card-body" id="pinnedList">
        <div class="empty-pinned">No pinned messages</div>
      </div>
    </div>

    <!-- Forum Guidelines -->
    <div class="sidebar-card">
      <div class="sidebar-card-header">
        <i class="fas fa-info-circle" style="color: #2563eb;"></i> Guidelines
      </div>
      <div class="sidebar-card-body" style="padding: 1rem;">
        <ul style="margin:0;padding-left:1.25rem;font-size:0.8rem;color:#6b7280;line-height:1.6;">
          <li>Be respectful and courteous</li>
          <li>Stay on topic in each category</li>
          <li>No spam or self-promotion</li>
          <li>Officers can pin important messages</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Jump to Present Button -->
<div class="jump-to-present" id="jumpBtn">
  <span>Jump to latest</span>
  <i class="fas fa-chevron-down"></i>
</div>

<!-- Copy Toast -->
<div class="copy-toast" id="copyToast">Copied to clipboard!</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const messagesList = document.getElementById('messagesList');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  const categoryTabs = document.getElementById('categoryTabs');
  const imageUpload = document.getElementById('imageUpload');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const previewFilename = document.getElementById('previewFilename');
  const removeImageBtn = document.getElementById('removeImageBtn');
  const imageError = document.getElementById('imageError');
  const pinnedList = document.getElementById('pinnedList');
  const jumpBtn = document.getElementById('jumpBtn');
  const copyToast = document.getElementById('copyToast');
  const forumTypeTabs = document.querySelectorAll('.forum-type-tab');

  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
  let currentCategory = categoryTabs.querySelector('.category-tab.active').dataset.id;
  let currentForumType = 'council';
  let originalMessages = [];
  let messageIds = new Set();
  let isSearching = false;
  let isSending = false;
  let isNearBottom = true;
  let selectedImage = null;

  const currentUser = {
    id: {{ current_user.id }},
    username: "{{ current_user.username }}",
    role: "{{ current_user.role }}",
    council: {{ current_user.council.id|default:"null" }}
  };

  // Forum Type Toggle
  forumTypeTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      forumTypeTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentForumType = tab.dataset.type;
      messageIds.clear();
      loadMessages(currentCategory, true);
    });
  });

  // Category Tabs
  categoryTabs.addEventListener('click', (e) => {
    if (e.target.classList.contains('category-tab')) {
      categoryTabs.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
      e.target.classList.add('active');
      currentCategory = e.target.dataset.id;
      messageIds.clear();
      loadMessages(currentCategory, true);
    }
  });

  // Helper functions
  function getRoleClass(role) {
    if (role === 'admin') return 'role-admin';
    if (role === 'officer') return 'role-officer';
    return 'role-member';
  }

  function getRoleLabel(role) {
    if (role === 'admin') return 'Director';
    if (role === 'officer') return 'Officer';
    return 'Member';
  }

  function getInitials(firstName, lastName) {
    return ((firstName || '')[0] || '') + ((lastName || '')[0] || '');
  }

  function isUserNearBottom() {
    return (messagesList.scrollHeight - messagesList.scrollTop - messagesList.clientHeight) < 150;
  }

  function updateJumpButton() {
    isNearBottom = isUserNearBottom();
    jumpBtn.classList.toggle('visible', !isNearBottom);
  }

  function scrollToBottom(force = false) {
    if (force || isNearBottom) {
      messagesList.scrollTo({ top: messagesList.scrollHeight, behavior: 'smooth' });
      setTimeout(updateJumpButton, 300);
    }
  }

  // Load Messages
  function loadMessages(categoryId, shouldScroll = true) {
    if (isSearching) return;

    fetch(`/forum/messages/${categoryId}/?forum_type=${currentForumType}`)
      .then(res => res.json())
      .then(data => {
        const sortedMessages = data.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        originalMessages = sortedMessages;

        const hasNew = sortedMessages.some(m => !messageIds.has(m.id));
        if (!hasNew && messageIds.size > 0 && !window.searchJustCleared) return;
        window.searchJustCleared = false;

        messagesList.innerHTML = '';
        sortedMessages.forEach(msg => {
          messageIds.add(msg.id);
          messagesList.appendChild(createMessageCard(msg));
        });

        if (shouldScroll) scrollToBottom();
        updateJumpButton();
        updatePinnedList();
      });
  }

  // Create Message Card
  function createMessageCard(msg, isNew = false) {
    const isOwn = msg.sender === currentUser.username;
    const canPin = currentUser.role === 'admin' || currentUser.role === 'officer';

    const div = document.createElement('div');
    div.className = `message-card${msg.is_pinned ? ' pinned' : ''}${isOwn ? ' own' : ''}${isNew ? ' new' : ''}`;
    div.dataset.messageId = msg.id;

    const avatarHtml = msg.sender_profile_picture
      ? `<img src="${msg.sender_profile_picture}" alt="${msg.sender_first_name}">`
      : `<div class="initials">${getInitials(msg.sender_first_name, msg.sender_last_name)}</div>`;

    const imageHtml = msg.image_url ? `<img src="${msg.image_url}" alt="Shared image" class="message-image">` : '';

    div.innerHTML = `
      ${msg.is_pinned ? '<div class="pin-badge"><i class="fas fa-thumbtack"></i></div>' : ''}
      <div class="message-header">
        <div class="message-avatar">${avatarHtml}</div>
        <div class="message-meta">
          <div class="message-sender">
            <span class="sender-name">${msg.sender_first_name} ${msg.sender_last_name}</span>
            <span class="sender-role ${getRoleClass(msg.sender_role)}">${getRoleLabel(msg.sender_role)}</span>
          </div>
          <div class="message-time">${msg.timestamp}</div>
        </div>
      </div>
      <div class="message-content">${msg.content}</div>
      ${imageHtml}
      <div class="message-actions-btn">
        <div class="action-trigger"><i class="fas fa-ellipsis-v"></i></div>
        <div class="action-menu">
          <button class="action-item copy-btn" data-id="${msg.id}"><i class="fas fa-copy"></i> Copy</button>
          ${msg.can_delete ? `<button class="action-item delete delete-btn" data-id="${msg.id}"><i class="fas fa-trash"></i> Delete</button>` : ''}
          ${canPin ? `<button class="action-item pin-btn" data-id="${msg.id}" data-pinned="${msg.is_pinned}"><i class="fas fa-thumbtack"></i> ${msg.is_pinned ? 'Unpin' : 'Pin'}</button>` : ''}
        </div>
      </div>
    `;

    return div;
  }

  // Update Pinned List
  function updatePinnedList() {
    const pinned = originalMessages.filter(m => m.is_pinned);
    if (pinned.length === 0) {
      pinnedList.innerHTML = '<div class="empty-pinned">No pinned messages</div>';
      return;
    }

    pinnedList.innerHTML = '';
    pinned.forEach(msg => {
      const item = document.createElement('div');
      item.className = 'pinned-item';
      item.dataset.messageId = msg.id;
      item.innerHTML = `
        <div class="pinned-item-sender">${msg.sender_first_name} ${msg.sender_last_name}</div>
        <div class="pinned-item-preview">${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}</div>
        <div class="pinned-item-time">${msg.timestamp}</div>
      `;
      item.addEventListener('click', () => scrollToMessage(msg.id));
      pinnedList.appendChild(item);
    });
  }

  function scrollToMessage(id) {
    const el = messagesList.querySelector(`.message-card[data-message-id="${id}"]`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.boxShadow = '0 0 0 3px rgba(37,99,235,0.3)';
      setTimeout(() => el.style.boxShadow = '', 2000);
    }
  }

  // Send Message
  function sendMessage() {
    const content = messageInput.value.trim();
    if ((!content && !selectedImage) || isSending) return;

    if (selectedImage && selectedImage.size > MAX_FILE_SIZE) {
      showImageError();
      clearSelectedImage();
      return;
    }

    isSending = true;
    sendBtn.disabled = true;

    const formData = new FormData();
    formData.append('category_id', currentCategory);
    formData.append('content', content);
    formData.append('forum_type', currentForumType);
    if (selectedImage) formData.append('image', selectedImage);

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch('/forum/send/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        messageInput.value = '';
        clearSelectedImage();
        isNearBottom = true;
        loadMessages(currentCategory, true);
      }
    })
    .finally(() => {
      isSending = false;
      sendBtn.disabled = false;
    });
  }

  // Search
  function searchMessages(query) {
    if (!query) {
      isSearching = false;
      clearSearchBtn.classList.remove('visible');
      window.searchJustCleared = true;
      messageIds.clear();
      loadMessages(currentCategory, false);
      return;
    }

    isSearching = true;
    clearSearchBtn.classList.add('visible');

    const results = originalMessages.filter(m =>
      m.content.toLowerCase().includes(query.toLowerCase()) ||
      `${m.sender_first_name} ${m.sender_last_name}`.toLowerCase().includes(query.toLowerCase())
    );

    messagesList.innerHTML = '';
    if (results.length === 0) {
      messagesList.innerHTML = '<div class="no-results-msg">No messages found</div>';
    } else {
      results.forEach(m => messagesList.appendChild(createMessageCard(m)));
    }
  }

  // Delete Message
  function deleteMessage(id, el) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    el.classList.add('deleting');

    fetch(`/forum/delete/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        setTimeout(() => {
          el.remove();
          originalMessages = originalMessages.filter(m => m.id !== parseInt(id));
          messageIds.delete(parseInt(id));
          updatePinnedList();
        }, 400);
      } else {
        el.classList.remove('deleting');
      }
    });
  }

  // Toggle Pin
  function togglePin(id) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/forum/pin/${id}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const idx = originalMessages.findIndex(m => m.id === parseInt(id));
        if (idx !== -1) originalMessages[idx].is_pinned = data.is_pinned;
        updatePinnedList();
        messageIds.clear();
        loadMessages(currentCategory, false);
      }
    });
  }

  // Copy Text
  function copyText(id) {
    const msg = originalMessages.find(m => m.id === parseInt(id));
    if (msg) {
      navigator.clipboard.writeText(msg.content).then(() => {
        copyToast.classList.add('show');
        setTimeout(() => copyToast.classList.remove('show'), 2000);
      });
    }
  }

  // Image Handling
  imageUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > MAX_FILE_SIZE) {
      showImageError();
      imageUpload.value = '';
      return;
    }

    selectedImage = file;
    const reader = new FileReader();
    reader.onload = (ev) => {
      previewImg.src = ev.target.result;
      previewFilename.textContent = file.name;
      imagePreview.classList.add('visible');
    };
    reader.readAsDataURL(file);
  });

  removeImageBtn.addEventListener('click', clearSelectedImage);

  function clearSelectedImage() {
    selectedImage = null;
    imageUpload.value = '';
    imagePreview.classList.remove('visible');
  }

  function showImageError() {
    imageError.classList.add('visible');
    setTimeout(() => imageError.classList.remove('visible'), 5000);
  }

  // Event Delegation for Actions
  messagesList.addEventListener('click', (e) => {
    // Toggle menu
    if (e.target.closest('.action-trigger')) {
      const menu = e.target.closest('.message-actions-btn').querySelector('.action-menu');
      document.querySelectorAll('.action-menu.show').forEach(m => { if (m !== menu) m.classList.remove('show'); });
      menu.classList.toggle('show');
      e.stopPropagation();
      return;
    }

    // Copy
    if (e.target.closest('.copy-btn')) {
      const id = e.target.closest('.copy-btn').dataset.id;
      copyText(id);
      e.target.closest('.action-menu').classList.remove('show');
      e.stopPropagation();
      return;
    }

    // Delete
    if (e.target.closest('.delete-btn')) {
      const btn = e.target.closest('.delete-btn');
      const id = btn.dataset.id;
      const card = btn.closest('.message-card');
      btn.closest('.action-menu').classList.remove('show');

      if (confirm('Delete this message?')) {
        deleteMessage(id, card);
      }
      e.stopPropagation();
      return;
    }

    // Pin
    if (e.target.closest('.pin-btn')) {
      const btn = e.target.closest('.pin-btn');
      const id = btn.dataset.id;
      const card = btn.closest('.message-card');
      btn.closest('.action-menu').classList.remove('show');
      card.classList.add('pinning');
      setTimeout(() => card.classList.remove('pinning'), 400);
      togglePin(id);
      e.stopPropagation();
      return;
    }
  });

  // Close menus on outside click
  document.addEventListener('click', () => {
    document.querySelectorAll('.action-menu.show').forEach(m => m.classList.remove('show'));
  });

  // Send Events
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Search Events
  searchBtn.addEventListener('click', () => searchMessages(searchInput.value.trim()));
  clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; searchMessages(''); });
  searchInput.addEventListener('keyup', (e) => {
    if (e.key === 'Enter') searchMessages(searchInput.value.trim());
    if (e.key === 'Escape') { searchInput.value = ''; searchMessages(''); }
  });

  // Scroll Events
  messagesList.addEventListener('scroll', updateJumpButton);
  jumpBtn.addEventListener('click', () => scrollToBottom(true));

  // Initial Load
  loadMessages(currentCategory, true);

  // Auto-refresh
  setInterval(() => {
    if (!isSearching && !isSending) loadMessages(currentCategory, isNearBottom);
  }, 3000);
});
</script>
{% endblock %}
