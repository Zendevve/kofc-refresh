{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Pending Users - Knights of Columbus{% endblock %}

{% block page_title %}Pending Users{% endblock %}
{% block breadcrumbs %}
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item">Management</span>
<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
<span class="breadcrumb-item current">Pending Users</span>
{% endblock %}

{% block header_actions %}
{% if request.user.role == 'admin' %}
<a href="{% url 'my_recruits' %}" class="btn btn--ghost">
  <i class="fas fa-users"></i> My Recruits
</a>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  /* Stats */
  .pending-stats {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .pending-stat {
    background: white;
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    text-align: center;
    flex: 1;
    max-width: 200px;
  }

  .pending-stat-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--warning-600);
  }

  .pending-stat-label {
    font-size: var(--text-sm);
    color: var(--neutral-500);
  }

  /* Filters */
  .pending-filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
    align-items: center;
  }

  .pending-search {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .pending-search i {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--neutral-400);
  }

  .pending-search input {
    width: 100%;
    padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
  }

  .pending-search input:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .sort-select {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    background: white;
    cursor: pointer;
  }

  .view-toggle {
    display: flex;
    border: 1px solid var(--neutral-300);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .view-toggle-btn {
    padding: var(--space-2) var(--space-3);
    background: white;
    border: none;
    color: var(--neutral-500);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .view-toggle-btn:hover {
    background: var(--neutral-50);
  }

  .view-toggle-btn.active {
    background: var(--primary-700);
    color: white;
  }

  /* Users Container */
  .users-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: var(--space-4);
  }

  .users-container.list-view {
    grid-template-columns: 1fr;
    gap: var(--space-2);
  }

  /* User Card */
  .user-card {
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
    border-left: 4px solid var(--warning-500);
    padding: var(--space-5);
    transition: all var(--transition-base);
  }

  .user-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .user-card-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-full);
    object-fit: cover;
    background: var(--neutral-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-400);
    font-size: var(--text-xl);
    flex-shrink: 0;
  }

  .user-info {
    flex: 1;
    min-width: 0;
  }

  .user-name {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--neutral-900);
    margin-bottom: var(--space-1);
  }

  .user-email {
    font-size: var(--text-sm);
    color: var(--neutral-500);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .user-card-body {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .user-meta {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--neutral-500);
    background: var(--neutral-100);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-md);
  }

  .pending-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
  }

  /* Action Buttons */
  .user-card-actions {
    display: flex;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--neutral-100);
  }

  .action-btn {
    flex: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-decoration: none;
    transition: all var(--transition-fast);
    cursor: pointer;
    border: none;
  }

  .view-btn {
    background: var(--primary-700);
    color: white;
  }

  .view-btn:hover {
    background: var(--primary-800);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13, 52, 113, 0.3);
  }

  /* List View */
  .list-view .user-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-3) var(--space-4);
    border-radius: var(--radius-lg);
  }

  .list-view .user-card:hover {
    transform: none;
    box-shadow: var(--shadow-sm);
  }

  .list-view .user-card-header {
    margin-bottom: 0;
    flex-shrink: 0;
    min-width: 200px;
  }

  .list-view .user-avatar {
    width: 36px;
    height: 36px;
    font-size: var(--text-base);
  }

  .list-view .user-name {
    font-size: var(--text-sm);
  }

  .list-view .user-email {
    font-size: var(--text-xs);
  }

  .list-view .user-card-body {
    flex: 1;
    margin-bottom: 0;
    justify-content: flex-start;
  }

  .list-view .user-card-actions {
    padding-top: 0;
    border-top: none;
    flex-shrink: 0;
  }

  .list-view .action-btn {
    flex: initial;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: var(--z-modal);
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    border-radius: var(--radius-xl);
    max-width: 650px;
    width: 100%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    animation: modalSlideIn 0.3s var(--ease-out);
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--neutral-200);
  }

  .modal-header h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    margin: 0;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    border: none;
    background: var(--neutral-100);
    color: var(--neutral-600);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--neutral-200);
    color: var(--neutral-900);
  }

  .modal-body {
    padding: var(--space-6);
  }

  .user-details-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-5);
    border-bottom: 1px solid var(--neutral-100);
  }

  .user-details-avatar {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-full);
    object-fit: cover;
    background: var(--neutral-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--neutral-400);
    font-size: var(--text-2xl);
    border: 3px solid var(--warning-400);
  }

  .user-details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .detail-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .detail-group.full-width {
    grid-column: span 2;
  }

  .detail-group strong {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--neutral-500);
    text-transform: uppercase;
  }

  .detail-group span {
    font-size: var(--text-sm);
    color: var(--neutral-800);
  }

  .signature-container {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--neutral-50);
    border-radius: var(--radius-lg);
    text-align: center;
  }

  .signature-container img {
    max-width: 100%;
    max-height: 150px;
  }

  .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--neutral-200);
    background: var(--neutral-50);
  }

  .modal-actions {
    display: flex;
    gap: var(--space-2);
  }

  .approve-btn {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    border: none;
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .approve-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
  }

  .reject-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    border: none;
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .reject-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-12);
    color: var(--neutral-500);
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--neutral-200);
  }

  .empty-state i {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-4);
    color: var(--success-500);
  }

  @media (max-width: 768px) {
    .pending-filters {
      flex-direction: column;
    }

    .pending-search {
      min-width: 100%;
    }

    .users-container {
      grid-template-columns: 1fr;
    }

    .user-details-grid {
      grid-template-columns: 1fr;
    }

    .detail-group.full-width {
      grid-column: span 1;
    }

    .modal-footer {
      flex-direction: column;
    }

    .modal-actions {
      width: 100%;
      justify-content: stretch;
    }

    .modal-actions button {
      flex: 1;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Stats -->
<div class="pending-stats">
  <div class="pending-stat">
    <div class="pending-stat-value">{{ pending_users|length }}</div>
    <div class="pending-stat-label">Pending Requests</div>
  </div>
</div>

<!-- Filters -->
<div class="pending-filters">
  <div class="pending-search">
    <i class="fas fa-search"></i>
    <input type="text" id="pendingUserSearch" placeholder="Search by name, email, or council...">
  </div>
  <select id="sortSelect" class="sort-select">
    <option value="newest">Newest First</option>
    <option value="oldest">Oldest First</option>
    <option value="alphabetical">A → Z</option>
    <option value="reverse-alphabetical">Z → A</option>
  </select>
  <div class="view-toggle">
    <button class="view-toggle-btn active" data-view="grid" title="Grid View"><i class="fas fa-th-large"></i></button>
    <button class="view-toggle-btn" data-view="list" title="List View"><i class="fas fa-list"></i></button>
  </div>
</div>

<!-- Users Container -->
{% if pending_users %}
<div class="users-container" id="usersContainer">
  {% for user in pending_users %}
  <div class="user-card" data-name="{{ user.first_name }} {{ user.last_name }}"
    data-joined="{{ user.date_joined|date:'Y-m-d' }}">
    <div class="user-card-header">
      {% if user.profile_picture %}
      <img src="{{ user.profile_picture.url }}" alt="{{ user.first_name }}" class="user-avatar">
      {% else %}
      <div class="user-avatar"><i class="fas fa-user"></i></div>
      {% endif %}
      <div class="user-info">
        <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
        <div class="user-email">{{ user.email }}</div>
      </div>
    </div>
    <div class="user-card-body">
      <span class="pending-badge"><i class="fas fa-clock"></i> Pending</span>
      <span class="user-meta"><i class="fas fa-building"></i> {{ user.council.name }}</span>
      <span class="user-meta"><i class="fas fa-calendar"></i> {{ user.date_joined|date:"M j, Y" }}</span>
    </div>
    <div class="user-card-actions">
      <button class="action-btn view-btn" data-user-id="{{ user.id }}">
        <i class="fas fa-eye"></i> Review Application
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state">
  <i class="fas fa-check-circle"></i>
  <h3>All caught up!</h3>
  <p>No pending membership requests to review.</p>
</div>
{% endif %}

<!-- User Details Modal -->
<div id="memberDetailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Membership Application</h3>
      <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" id="memberDetailsContent">
      <div style="text-align: center; padding: 2rem; color: var(--neutral-500);">
        <i class="fas fa-spinner fa-spin"></i> Loading...
      </div>
    </div>
    <div class="modal-footer" id="modalFooter">
      <div class="modal-actions">
        <button class="approve-btn" id="approveBtn"><i class="fas fa-check"></i> Approve</button>
        <button class="reject-btn" id="rejectBtn"><i class="fas fa-times"></i> Reject</button>
      </div>
      <button class="btn btn--ghost" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const cards = document.querySelectorAll('.user-card');
    const container = document.getElementById('usersContainer');
    const searchInput = document.getElementById('pendingUserSearch');
    const sortSelect = document.getElementById('sortSelect');

    // Search
    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const term = this.value.toLowerCase();
        cards.forEach(card => {
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(term) ? '' : 'none';
        });
      });
    }

    // Sort
    function sortCards() {
      if (!container) return;
      const cardsArr = Array.from(cards);
      cardsArr.sort((a, b) => {
        switch (sortSelect.value) {
          case 'alphabetical':
            return a.dataset.name.localeCompare(b.dataset.name);
          case 'reverse-alphabetical':
            return b.dataset.name.localeCompare(a.dataset.name);
          case 'newest':
            return new Date(b.dataset.joined) - new Date(a.dataset.joined);
          case 'oldest':
            return new Date(a.dataset.joined) - new Date(b.dataset.joined);
        }
      });
      cardsArr.forEach(card => container.appendChild(card));
    }

    sortSelect?.addEventListener('change', sortCards);
    sortCards();

    // View toggle
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    viewToggleBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        viewToggleBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        if (container) {
          container.classList.toggle('list-view', this.dataset.view === 'list');
        }
        localStorage.setItem('pendingUsersView', this.dataset.view);
      });
    });

    // Restore view preference
    const savedView = localStorage.getItem('pendingUsersView');
    if (savedView === 'list') {
      document.querySelector('.view-toggle-btn[data-view="list"]')?.click();
    }

    // Modal
    const modal = document.getElementById('memberDetailsModal');
    const content = document.getElementById('memberDetailsContent');
    let currentUserId = null;

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        currentUserId = this.dataset.userId;
        modal.classList.add('show');
        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--neutral-500);"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

        fetch(`/user/${currentUserId}/details/`)
          .then(res => res.json())
          .then(data => {
            content.innerHTML = `
            <div class="user-details-header">
              ${data.profile_picture
                ? `<img src="${data.profile_picture}" class="user-details-avatar">`
                : `<div class="user-details-avatar"><i class="fas fa-user"></i></div>`}
              <div>
                <h4 style="margin: 0 0 var(--space-2); font-size: var(--text-xl);">${data.first_name} ${data.middle_name || ''} ${data.last_name}${data.suffix ? ' ' + data.suffix : ''}</h4>
                <span class="pending-badge"><i class="fas fa-clock"></i> Pending Approval</span>
              </div>
            </div>
            <div class="user-details-grid">
              <div class="detail-group"><strong>Email</strong><span>${data.email}</span></div>
              <div class="detail-group"><strong>Username</strong><span>${data.username}</span></div>
              <div class="detail-group"><strong>Contact</strong><span>${data.contact_number || 'Not provided'}</span></div>
              <div class="detail-group"><strong>Council</strong><span>${data.council_name || 'No council'}</span></div>
              <div class="detail-group"><strong>Birthday</strong><span>${data.birthday || 'Not provided'}</span></div>
              <div class="detail-group"><strong>Age</strong><span>${data.age || 'N/A'}</span></div>
              <div class="detail-group full-width"><strong>Address</strong><span>${data.street ? `${data.street}, ${data.barangay}, ${data.city}, ${data.province} ${data.zip_code}` : 'Not provided'}</span></div>
              <div class="detail-group"><strong>Marital Status</strong><span>${data.marital_status || 'Not provided'}</span></div>
              <div class="detail-group"><strong>Occupation</strong><span>${data.occupation || 'Not provided'}</span></div>
              <div class="detail-group"><strong>Applied On</strong><span>${data.date_joined}</span></div>
              <div class="detail-group"><strong>Recruiter</strong><span>${data.recruiter_name || (data.voluntary_join ? 'Voluntary' : 'Not specified')}</span></div>
              ${data.join_reason ? `<div class="detail-group full-width"><strong>Why They Want to Join</strong><span>${data.join_reason}</span></div>` : ''}
            </div>
            ${data.e_signature ? `<div class="signature-container"><strong>E-Signature</strong><img src="${data.e_signature}" alt="Signature"></div>` : ''}
          `;
          })
          .catch(() => {
            content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--error-600);"><i class="fas fa-exclamation-circle"></i> Error loading details</div>';
          });
      });
    });

    // Approve/Reject handlers
    document.getElementById('approveBtn')?.addEventListener('click', function () {
      if (currentUserId && confirm('Approve this membership request?')) {
        window.location.href = `/approve-user/${currentUserId}/`;
      }
    });

    document.getElementById('rejectBtn')?.addEventListener('click', function () {
      if (currentUserId && confirm('Reject this membership request?')) {
        window.location.href = `/reject-user/${currentUserId}/`;
      }
    });
  });

  function closeModal() {
    document.getElementById('memberDetailsModal').classList.remove('show');
  }

  document.getElementById('memberDetailsModal')?.addEventListener('click', function (e) {
    if (e.target === this) closeModal();
  });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') closeModal();
  });
</script>
{% endblock %}
