{% extends 'base.html' %}
{% load static %}

{% block title %}Knights of Columbus - Blockchain Ledger{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/blockchain.css' %}">

<div class="blockchain-container">
    <div class="header">
        <h1>Donation Ledger</h1>
        <p>Transparent, immutable, and mathematically verifiable donations.</p>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="summary">
        <p><strong>Total Blocks:</strong> {{ total_blocks }}</p>
        <p><strong>Total Transactions:</strong> {{ total_transactions }}</p>
        <p><strong>Pending Transactions:</strong> {{ pending_transactions|length }}</p>
    </div>

    <div class="controls">
        <form method="get" class="filter-form" id="ledger-filter-form" aria-label="Filter donation ledger">
            {% csrf_token %}

            {% if user.is_authenticated %}
                <div>
                    <label for="search_name">Donor Name</label>
                    <input type="text" id="search_name" name="search_name" 
                           placeholder="e.g. J*hn D*e" value="{{ request.GET.search_name|default:'' }}"
                           aria-label="Search by donor name">
                </div>
                <div>
                    <label for="search_tx">Transaction ID</label>
                    <input type="text" id="search_tx" name="search_tx" 
                           placeholder="e.g. GCASH-ABCD1234" value="{{ request.GET.search_tx|default:'' }}"
                           aria-label="Search by transaction ID">
                </div>
            {% endif %}

            <div>
                <label for="date_from">Date From</label>
                <input type="date" id="date_from" name="date_from" value="{{ request.GET.date_from|default:'' }}">
            </div>
            <div>
                <label for="date_to">Date To</label>
                <input type="date" id="date_to" name="date_to" value="{{ request.GET.date_to|default:'' }}">
            </div>
            <div>
                <label for="amount_min">Min Amount</label>
                <input type="number" id="amount_min" name="amount_min" step="0.01" placeholder="100">
            </div>
            <div>
                <label for="amount_max">Max Amount</label>
                <input type="number" id="amount_max" name="amount_max" step="0.01" placeholder="10000">
            </div>
            <div>
                <label for="method">Method</label>
                <select id="method" name="method">
                    <option value="">All</option>
                    <option value="gcash" {% if request.GET.method == 'gcash' %}selected{% endif %}>GCash</option>
                    <option value="manual" {% if request.GET.method == 'manual' %}selected{% endif %}>Manual</option>
                </select>
            </div>
            <div>
                <label for="sort">Sort By</label>
                <select id="sort" name="sort">
                    <option value="recent_to_oldest" {% if not request.GET.sort or request.GET.sort == 'recent_to_oldest' %}selected{% endif %}>Recent First</option>
                    <option value="oldest_to_recent">Oldest First</option>
                    <option value="highest_amount">Highest Amount</option>
                    <option value="lowest_amount">Lowest Amount</option>
                </select>
            </div>

            <div id="date-error" role="alert" style="display:none;color:#ff4444;margin-top:8px;">
                Error: "Date From" cannot be after "Date To"
            </div>

            <button type="submit" id="filter-btn">Apply Filters</button>
            <a href="{% url 'blockchain' %}" class="clear-button">Clear All</a>
            {% if user.is_authenticated and user.role in admin_officer_roles %}
                <a href="{% url 'download_ledger' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}"
                   class="download-button">Download Ledger (Excel)</a>
            {% endif %}
        </form>

    </div>

    {% if page_obj %}
        <div class="table-container">
            <table class="blockchain-table">
                <thead>
                    <tr>
                        <th>Block</th>
                        <th>Date & Time</th>
                        <th>Amount</th>
                        <th>Transaction ID</th>
                        <th>Donor</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in page_obj %}
                    <tr>
                        <!-- BLOCK NUMBER -->
                        <td>
                            {% if tx.block_index %}
                                <strong>#{{ tx.block_index }}</strong>
                            {% else %}
                                <em style="color:#ffb74d;">Pending</em>
                            {% endif %}
                        </td>

                        <!-- TIMESTAMP -->
                        <td>
                            {% if tx.block_timestamp %}
                                {{ tx.block_timestamp|date:"M d, Y H:i" }}
                            {% else %}
                                <span style="color:#888;">—</span>
                            {% endif %}
                        </td>

                        <!-- AMOUNT -->
                        <td class="amount-cell">₱{{ tx.amount|floatformat:2 }}</td>

                        <!-- TX ID -->
                        <td><code>{{ tx.transaction_id }}</code></td>

                        <!-- DONOR (masked) -->
                        <td>{{ tx.donor|default:"Anonymous Donor" }}</td>

                        <!-- STATUS -->
                        <td>
                            {% if tx.block_index %}
                                <span class="status-on-chain">On Chain</span>
                            {% else %}
                                <span class="status-pending">Pending</span>
                            {% endif %}
                        </td>

                        <!-- ACTIONS -->
                        <td class="actions-cell">
                            <button type="button" class="btn-small view-details"
                                    data-tx-id="{{ tx.transaction_id }}"
                                    data-donor="{{ tx.donor|default:'Anonymous Donor' }}"
                                    data-amount="{{ tx.amount|floatformat:2 }}"
                                    data-date="{{ tx.donation_date|date:'M d, Y'|default:'—' }}"
                                    data-method="{{ tx.payment_method|default:'—' }}"
                                    data-status="{% if tx.block_index %}Permanently Recorded{% else %}Awaiting Confirmation{% endif %}"
                                    data-block="{% if tx.block_index %}#{{ tx.block_index }}{% else %}Not yet mined{% endif %}"
                                    data-timestamp="{% if tx.block_timestamp %}{{ tx.block_timestamp|date:'M d, Y H:i' }}{% else %}—{% endif %}">
                                Details
                            </button>

                            {% if user.is_authenticated and user.role in admin_officer_roles and tx.id %}
                                <a href="{% url 'download_receipt' donation_id=tx.id %}" class="btn-small receipt-btn">
                                    Receipt
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination" aria-label="Pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET %}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v|urlencode }}{% endif %}{% endfor %}{% endif %}"
                   class="pagination-link">Previous</a>
            {% endif %}
            <span class="pagination-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET %}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v|urlencode }}{% endif %}{% endfor %}{% endif %}"
                   class="pagination-link">Next</a>
            {% endif %}
        </div>
    {% else %}
        <div class="no-data"><p>No transactions found.</p></div>
    {% endif %}

    <a href="{% url 'donations' %}" class="back-button">Back to Donations</a>
</div>

<!-- EPIC Transaction Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <button type="button" class="close-btn">×</button>
        <div class="receipt-preview">
            <div class="receipt-header">
                <h3>Donation Details</h3>
                <p>Knights of Columbus • Private Blockchain</p>
            </div>
            <div class="receipt-body">
                <table class="receipt-table">
                    <tr><td><strong>Transaction ID</strong></td><td><code id="modal-tx-id"></code></td></tr>
                    <tr><td><strong>Donor</strong></td><td id="modal-donor"></td></tr>
                    <tr><td><strong>Amount</strong></td><td class="amount-highlight">₱<span id="modal-amount"></span></td></tr>
                    <tr><td><strong>Date Donated</strong></td><td id="modal-date"></td></tr>
                    <tr><td><strong>Payment Method</strong></td><td id="modal-method"></td></tr>
                    <tr><td><strong>Status</strong></td><td id="modal-status" style="font-weight:600;"></td></tr>
                    <tr><td><strong>Block</strong></td><td id="modal-block"></td></tr>
                    <tr><td><strong>Recorded On</strong></td><td id="modal-timestamp"></td></tr>
                </table>
                <div style="margin-top:30px;padding:20px;background:rgba(244,180,26,0.15);border-radius:12px;text-align:center;font-style:italic;">
                    This record is permanently stored on our private blockchain and cannot be altered.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.view-details').forEach(btn => {
        btn.onclick = () => {
            document.getElementById('modal-tx-id').textContent = btn.dataset.txId;
            document.getElementById('modal-donor').textContent = btn.dataset.donor;
            document.getElementById('modal-amount').textContent = btn.dataset.amount;
            document.getElementById('modal-date').textContent = btn.dataset.date;
            document.getElementById('modal-method').textContent = btn.dataset.method;
            document.getElementById('modal-status').textContent = btn.dataset.status;
            document.getElementById('modal-status').style.color = btn.dataset.status.includes('Permanent') ? '#4ade80' : '#ffb74d';
            document.getElementById('modal-block').textContent = btn.dataset.block;
            document.getElementById('modal-timestamp').textContent = btn.dataset.timestamp;
            document.getElementById('detailsModal').style.display = 'block';
        };
    });

    document.querySelector('.close-btn').onclick = () => {
        document.getElementById('detailsModal').style.display = 'none';
    };

    window.onclick = (e) => {
        if (e.target === document.getElementById('detailsModal')) {
            document.getElementById('detailsModal').style.display = 'none';
        }
    };
});
</script>

{% endblock %}