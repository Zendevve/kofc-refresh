{% extends 'base.html' %}
{% load static %}
{% block title %}
Knights of Columbus - Admin Dashboard
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard_shared.css' %}?v={% now 'U' %}">

<div class="dashboard-container">
    <div class="dashboard-title">
        <div class="title-section">
            <h1>Admin Dashboard</h1>
            <h2>Welcome, {{ user.first_name }} {{ user.last_name }}</h2>
        </div>
        <div class="bible-verse-section">
            <div class="verse-header">
                <i class="fas fa-book-open"></i>
                <span>Daily Inspiration</span>
            </div>
            <blockquote class="bible-verse-inline">
                <p>"{{ daily_verse.verse }}"</p>
                <cite>- {{ daily_verse.reference }}</cite>
            </blockquote>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Profile Card -->
        <div class="dashboard-card" style="animation-delay: 0.1s;">
            <div class="card-header">
                <h3>Profile Information</h3>
            </div>
            <div class="card-content">
                <div class="profile-info">
                    <div class="profile-pic{% if user.is_inactive_member %} inactive{% endif %}">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="Profile Picture">
                        {% else %}
                            <i class="fas fa-user" style="font-size: 3rem; color: #0D3471;"></i>
                        {% endif %}
                    </div>
                    <h4>{{ user.first_name }} {{ user.last_name }}</h4>
                    <p>{{ user.council.name|default:"No council assigned" }}</p>
                    <p><span class="degree-badge degree-{{ user.current_degree|default:'1st' }}">{{ user.get_current_degree_display }}</span></p>
                    <div class="action-buttons">
                        <a href="{% url 'edit_profile' %}" class="dashboard-btn">
                            <i class="fas fa-user-edit"></i>Edit Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Recruits Card -->
        <div class="dashboard-card" style="animation-delay: 0.2s;">
            <div class="card-header">
                <h3>My Recruits</h3>
            </div>
            <div class="card-content">
                <p>Track your recruitment progress.</p>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" data-target="{{ user_recruitment_count|default:0 }}">0</div>
                        <div class="stat-label">Your Recruits</div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <a href="{% url 'my_recruits' %}" class="dashboard-btn">
                    <i class="fas fa-users"></i>View My Recruits
                </a>
            </div>
        </div>

        <!-- Users Management Card -->
        <div class="dashboard-card" style="animation-delay: 0.3s;">
            <div class="card-header">
                <h3>Users Management</h3>
            </div>
            <div class="card-content">
                <p>Manage user roles and pending applications.</p>
                <div class="stat-grid">
                    <div class="stat-card2">
                        <div class="stat-value" id="activeCount" data-target="{{ active_users_count|default:0 }}">0</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="inactiveCount" data-target="{{ inactive_users_count|default:0 }}">0</div>
                        <div class="stat-label">Inactive</div>
                    </div>
                    <div class="stat-card2">
                        <div class="stat-value" id="totalMembers" data-target="{{ total_members|default:0 }}">0</div>
                        <div class="stat-label">Total Members</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" data-target="{{ pending_users_count|default:0 }}">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <a href="{% url 'manage_roles' %}" class="dashboard-btn"><i class="fas fa-user-tag"></i>Roles</a>
                <a href="{% url 'manage_pending_users' %}" class="dashboard-btn"><i class="fas fa-user-clock"></i>Pending</a>
                <a href="{% url 'member_list' %}" class="dashboard-btn"><i class="fas fa-list"></i>All Users</a>
            </div>
        </div>

        <!-- Events Card -->
        <div class="dashboard-card" style="animation-delay: 0.4s;">
            <div class="card-header">
                <h3>Events</h3>
            </div>
            <div class="card-content">
                <p>Manage event proposals and view upcoming events.</p>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" data-target="{{ approved_events_count }}">0</div>
                        <div class="stat-label">Approved / Incoming</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" data-target="{{ pending_events_count|default:0 }}">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <a href="{% url 'add_event' %}" class="dashboard-btn"><i class="fas fa-plus"></i>Add</a>
                <a href="{% url 'event_proposals' %}" class="dashboard-btn"><i class="fas fa-clipboard-check"></i>Proposals</a>
                <a href="{% url 'event_list' %}" class="dashboard-btn"><i class="fas fa-list"></i>Events</a>
                <a href="{% url 'archived_events' %}" class="dashboard-btn"><i class="fas fa-archive"></i>Archived</a>
            </div>
        </div>

         <!-- Council Settings Card -->
         <div class="dashboard-card" style="animation-delay: 0.8s;">
            <div class="card-header">
                <h3>Council Settings</h3>
            </div>
            <div class="card-content">
                <p>Manage councils - add new councils or remove existing ones.</p>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-value" data-target="{{ councils_count|default:0 }}">0</div>
                        <div class="stat-label">Total Councils</div>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <a href="{% url 'manage_councils' %}" class="dashboard-btn">
                    <i class="fas fa-cogs"></i>Manage Councils
                </a>
            </div>
        </div>

        <!-- Analytics Card -->
        <div class="dashboard-card" style="animation-delay: 0.5s;">
            <div class="card-header">
                <h3>Council Analytics</h3>
            </div>
            <div class="card-content">
                <p>View all council reports and performance metrics.</p>
            </div>
            <div class="action-buttons">
                <a href="{% url 'analytics_view' %}" class="dashboard-btn">
                    <i class="fas fa-chart-line"></i>View Analytics
                </a>
            </div>
        </div>

        <!-- Leaderboard Card -->
        <div class="dashboard-card" style="animation-delay: 0.6s;">
            <div class="card-header">
                <h3>Leaderboard</h3>
            </div>
            <div class="card-content">
                <p>See top recruiters and your rank.</p>
            </div>
            <div class="action-buttons">
                <a href="{% url 'leaderboard' %}" class="dashboard-btn">
                    <i class="fas fa-trophy"></i>View Leaderboard
                </a>
            </div>
        </div>

        <!-- Community Chat Button -->
        <div class="dashboard-card" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h3>Community Chat</h3>
            </div>
            <div class="card-content">
                <p>Join our community chat to connect with other members.</p>
            </div>
            <div class="action-buttons">
                <a href="{% url 'forum' %}" class="dashboard-btn">
                    <i class="fas fa-comments"></i>Community Chat
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards with staggered entrance
    const cards = document.querySelectorAll('.dashboard-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + (index * 100));
    });

    // Get total members count
    const totalMembersElement = document.getElementById('totalMembers');
    const totalMembers = parseInt(totalMembersElement.getAttribute('data-target')) || 0;
    
    // Animate counters with interdependent active/inactive
    const counters = document.querySelectorAll('.stat-value');
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target'));
        if (isNaN(target)) return;

        let current = 0;
        const duration = 1500; // 1.5 seconds
        const stepTime = 20; // update every 20ms
        const totalSteps = duration / stepTime;
        const increment = target / totalSteps;

        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                const finalValue = Math.floor(target);
                counter.textContent = finalValue;
                
                // Update interdependent counts for active/inactive
                if (counter.id === 'activeCount' || counter.id === 'inactiveCount') {
                    updateMemberCounts();
                }
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current);
            }
        }, stepTime);
    });
    
    // Function to update active/inactive counts to be interdependent
    function updateMemberCounts() {
        const activeElement = document.getElementById('activeCount');
        const inactiveElement = document.getElementById('inactiveCount');
        
        if (activeElement && inactiveElement) {
            const activeCount = parseInt(activeElement.textContent) || 0;
            const inactiveCount = parseInt(inactiveElement.textContent) || 0;
            const total = activeCount + inactiveCount;
            
            // Ensure they add up correctly
            if (total > 0) {
                // Store the ratio for future updates
                activeElement.dataset.ratio = activeCount / total;
            }
        }
    }
    
    // Set up auto-refresh for user counts (every 5 seconds)
    setInterval(() => {
        fetch('/api/user-counts/')
            .then(response => response.json())
            .then(data => {
                const activeElement = document.getElementById('activeCount');
                const inactiveElement = document.getElementById('inactiveCount');
                const totalElement = document.getElementById('totalMembers');
                
                if (activeElement && inactiveElement && totalElement) {
                    const newActive = data.active_count || 0;
                    const newInactive = data.inactive_count || 0;
                    const newTotal = newActive + newInactive + (data.pending_count || 0);
                    
                    // Update counts if they changed
                    if (parseInt(activeElement.textContent) !== newActive) {
                        activeElement.textContent = newActive;
                    }
                    if (parseInt(inactiveElement.textContent) !== newInactive) {
                        inactiveElement.textContent = newInactive;
                    }
                    if (parseInt(totalElement.textContent) !== newTotal) {
                        totalElement.textContent = newTotal;
                    }
                }
            })
            .catch(error => console.log('Auto-refresh paused'));
    }, 5000);
});

// Function to close inactive warning popup
function closeInactiveWarning() {
    const overlay = document.getElementById('inactiveWarningOverlay');
    if (overlay) {
        overlay.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}
</script>

<!-- Inactive Warning Popup -->
{% if show_inactive_warning %}
<div class="inactive-warning-overlay" id="inactiveWarningOverlay">
    <div class="inactive-warning-popup">
        <div class="warning-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Activity Warning</h3>
        <p>Your account has been inactive for more than 30 days. To maintain your active status, please participate in council events or recruitment activities.</p>
        <button class="warning-btn" onclick="closeInactiveWarning()">I Understand</button>
    </div>
</div>
{% endif %}

<style>
@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}
</style>
{% endblock %}