{% extends 'base.html' %}
{% load static %}

{% block title %}
Knights of Columbus - Add Recruitment Record
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard_shared.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="{% static 'css/event_management.css' %}?v={% now 'U' %}">


<div class="dashboard-container">
    <div class="content-card">
        <div class="dashboard-header">
            <h1 style="color: #0D3471">Add Recruitment Record</h1>
            <div>
                <a href="{% url 'dashboard' %}" class="dashboard-btn secondary back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
        
        <div class="form-container">
            <form method="post" action="{% url 'add_recruitment' %}">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="recruiter_search">Recruiter:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="recruiter_search" class="form-control search-input" placeholder="Type recruiter name..." autocomplete="off">
                        <input type="hidden" name="recruiter_id" id="recruiter_id" required>
                        <div id="recruiter_suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recruit_search">Recruit:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="recruit_search" class="form-control search-input" placeholder="Type recruit name..." autocomplete="off">
                        <input type="hidden" name="recruit_id" id="recruit_id" required>
                        <div id="recruit_suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="dashboard-btn">
                        <i class="fas fa-plus"></i> Add Recruitment Record
                    </button>
                </div>
            </form>
        </div>
        
        <div class="history-section">
            <h2>Recruitment History</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Recruiter</th>
                        <th>Recruit</th>
                        <th>Date</th>
                        <th>Source</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in all_recruitments %}
                    <tr>
                        <td data-user-id="{{ record.recruiter.id }}">
                            {% if record.recruiter.profile_picture %}
                            <img src="{{ record.recruiter.profile_picture.url }}" alt="{{ record.recruiter.first_name }}" class="profile-pic-small">
                            {% else %}
                            <i class="fas fa-user-circle profile-pic-small person-icon" style="font-size: 2.5rem; color: #6c757d;"></i>
                            {% endif %}
                            {{ record.recruiter.first_name }} {{ record.recruiter.last_name }}
                        </td>
                        <td data-user-id="{{ record.recruited.id }}">
                            {% if record.recruited.profile_picture %}
                            <img src="{{ record.recruited.profile_picture.url }}" alt="{{ record.recruited.first_name }}" class="profile-pic-small">
                            {% else %}
                            <i class="fas fa-user-circle profile-pic-small person-icon" style="font-size: 2.5rem; color: #6c757d;"></i>
                            {% endif %}
                            {{ record.recruited.first_name }} {{ record.recruited.last_name }}
                        </td>
                        <td>{{ record.date_recruited|date:"M d, Y" }}</td>
                        <td>
                            {% if record.is_manual %}
                            <span class="badge manual">Manual</span>
                            {% else %}
                            <span class="badge system">System</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if record.is_manual %}
                            <button type="button" class="undo-btn" data-id="{{ record.id }}" data-recruiter="{{ record.recruiter.first_name }} {{ record.recruiter.last_name }}" data-recruit="{{ record.recruited.first_name }} {{ record.recruited.last_name }}">
                                <i class="fas fa-undo"></i> Undo
                            </button>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Confirm Undo</h2>
        <p>Are you sure you want to undo this recruitment record?</p>
        <p><strong>Recruiter:</strong> <span id="recruiterName"></span></p>
        <p><strong>Recruit:</strong> <span id="recruitName"></span></p>
        <div class="modal-actions">
            <form id="undoForm" method="post" action="">
                {% csrf_token %}
                <button type="submit" class="dashboard-btn danger">Yes, Undo</button>
                <button type="button" class="dashboard-btn secondary cancel-btn">Cancel</button>
            </form>
        </div>
    </div>
</div>

<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        text-align: center;
        font-size: 1.2rem;
        padding: 0 1rem;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
        text-align: center;
        justify-content: center;
        max-width: 1200px; /* Limit maximum width for better readability */
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--heading-color);
        font-size: 1.5rem;
    }
    
    .form-control {
        width: 100%;
        min-width: 60vw;
        max-width: 80vw;
        padding: 0.75rem;
        border: 1px solid rgba(13, 52, 113, 0.2);
        border-radius: var(--border-radius);
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .custom-select-wrapper {
        width: 100%;
        min-width: 60vw;
        max-width: 80vw;
        position: relative;
        margin: 0 auto;
    }
    
    .custom-select {
        width: 100%;
        min-width: 60vw;
        max-width: 80vw;
    }
    
    /* Large screens - wider dropdowns */
    @media (min-width: 1200px) {
        .form-control {
            min-width: 50rem;
            max-width: 60rem;
        }
        
        .custom-select-wrapper {
            min-width: 50rem;
            max-width: 60rem;
        }
        
        .custom-select {
            min-width: 50rem;
            max-width: 60rem;
        }
    }
    
    /* Medium-large screens */
    @media (max-width: 1199px) and (min-width: 992px) {
        .form-control {
            min-width: 70vw;
            max-width: 85vw;
        }
        
        .custom-select-wrapper {
            min-width: 70vw;
            max-width: 85vw;
        }
        
        .custom-select {
            min-width: 70vw;
            max-width: 85vw;
        }
    }
    
    /* Tablet screens */
    @media (max-width: 991px) and (min-width: 769px) {
        .form-control {
            min-width: 65vw;
            max-width: 80vw;
        }
        
        .custom-select-wrapper {
            min-width: 65vw;
            max-width: 80vw;
        }
        
        .custom-select {
            min-width: 65vw;
            max-width: 80vw;
        }
    }
    
    /* Mobile screens */
    @media (max-width: 768px) {
        .form-group {
            max-width: 100%;
            padding: 0 0.5rem;
        }
        
        .form-control {
            min-width: 65vw;
            max-width: 80vw;
            font-size: 0.9rem;
        }
        
        .custom-select-wrapper {
            min-width: 65vw;
            max-width: 80vw;
        }
        
        .custom-select {
            min-width: 65vw;
            max-width: 80vw;
        }
        
        .form-container {
            padding: 0 0.25rem;
        }
    }
    
    /* Small mobile screens */
    @media (max-width: 480px) {
        .form-group {
            padding: 0 0.25rem;
        }
        
        .form-control {
            min-width: 90vw;
            max-width: 98vw;
            font-size: 0.85rem;
            padding: 0.6rem;
        }
        
        .custom-select-wrapper {
            min-width: 90vw;
            max-width: 98vw;
        }
        
        .custom-select {
            min-width: 90vw;
            max-width: 98vw;
        }
        
        .form-container {
            padding: 0 0.1rem;
        }
        
        .form-group label {
            font-size: 1.2rem;
        }
    }
    
    .form-actions {
        margin-top: 2rem;
        text-align: center;
    }
    
    .messages {
        margin-bottom: 2rem;
    }
    
    .message {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: var(--border-radius);
        background-color: #f8f9fa;
        border-left: 4px solid #6c757d;
    }
    
    .message.success {
        background-color: #d4edda;
        border-left-color: #28a745;
        color: #155724;
    }
    
    .message.error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
        color: #721c24;
    }
    
    .message.warning {
        background-color: #fff3cd;
        border-left-color: #ffc107;
        color: #856404;
    }
    
    .back-btn {
        margin-bottom: 1rem;
    }
    
    /* Profile picture in select options */
    .profile-pic-small {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    /* Person icon styling */
    .person-icon {
        width: 2.5rem;
        height: 2.5rem;
        margin-right: 8px;
        vertical-align: middle;
        border-radius: 50%;
        background-color: #f8f9fa;
        padding: 2px;
        border: 2px solid #dee2e6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #6c757d;
    }
    
    /* Custom select styling */
    .user-select {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        z-index: -1;
    }
    
    .custom-select-wrapper {
        position: relative;
        width: 100%;
    }
    
    .custom-select {
        position: relative;
        width: 100%;
        border: 1px solid rgba(13, 52, 113, 0.2);
        border-radius: var(--border-radius);
        cursor: pointer;
    }
    
    .selected-option {
        padding: 0.75rem;
        display: flex;
        align-items: center;
        background-color: white;
        border-radius: var(--border-radius);
        position: relative;
    }
    
    /* Person icon in selected option styling */
    .selected-option .person-icon {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.5rem;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #6c757d;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    .selected-option::after {
        content: '';
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #333;
    }
    
    .select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid rgba(13, 52, 113, 0.2);
        border-top: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Ensure dropdown doesn't overflow viewport */
    @media (max-height: 600px) {
        .select-dropdown {
            max-height: 150px;
        }
    }
    
    @media (max-height: 400px) {
        .select-dropdown {
            max-height: 100px;
        }
    }
    
    .custom-select.open .select-dropdown {
        display: block;
    }
    
    .select-option {
        padding: 0.75rem;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .select-option:hover {
        background-color: rgba(13, 52, 113, 0.05);
    }
    
    .select-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #f5f5f5;
    }
    
    .option-text {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    
    /* Person icon in dropdown styling */
    .select-option .person-icon {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.5rem;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #6c757d;
        margin-right: 8px;
        vertical-align: middle;
    }
    
    /* Enhanced select option styling */
    select.user-select option {
        padding: 8px;
        display: flex;
        align-items: center;
    }
    
    /* Firefox specific styling */
    @-moz-document url-prefix() {
        select.user-select {
            text-indent: 0.01px;
            text-overflow: '';
            padding-right: 1rem;
        }
    }
    
    /* Webkit browsers (Chrome, Safari) */
    @media screen and (-webkit-min-device-pixel-ratio:0) {
        select.user-select {
            padding-right: 2.5rem;
        }
    }
    
    /* IE10+ specific styles */
    @media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {
        select.user-select {
            padding-right: 2rem;
            background-image: none;
        }
    }
    
    /* Council badge */
    .council-badge {
        font-size: 0.75rem;
        color: #6c757d;
        background-color: #e9ecef;
        padding: 0.1rem 0.5rem;
        border-radius: 10px;
        margin-left: 0.5rem;
    }
    
    /* History section styles */
    .history-section {
        margin-top: 4rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(13, 52, 113, 0.2);
        clear: both;
    }
    
    /* Add spacing after form to prevent overlap */
    .form-container {
        margin-bottom: 3rem;
    }
    
    /* Ensure proper spacing between form groups */
    .form-group:last-of-type {
        margin-bottom: 2rem;
    }
    
    .history-section h2 {
        margin-bottom: 1.5rem;
        color: var(--heading-color);
        text-align: left;
        font-size: 1.5rem;
    }
    
    .history-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(13, 52, 113, 0.1);
        margin-top: 1rem;
        position: relative;
    }
    
    .history-table::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .history-table th,
    .history-table td {
        padding: 1rem 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(13, 52, 113, 0.08);
        vertical-align: middle;
    }
    
    .history-table th {
        padding: 1.5rem 1rem;
        background-color: var(--primary-bg);
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        text-transform: uppercase;
    }
    
    .history-table tbody tr:hover {
        background-color: rgba(13, 52, 113, 0.06);
    }
    
    .history-table tr:last-child td {
        border-bottom: none;
    }
    
    .badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .badge.system {
        background-color: var(--accent-color);
        color: var(--primary-bg);
    }
    
    .badge.manual {
        background-color: var(--primary-bg);
        color: white;
    }
    
    .undo-btn {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .undo-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
    }
    
    /* Mobile responsive table */
    @media (max-width: 768px) {
        .history-table { 
            display: block; 
            overflow-x: auto; 
            white-space: nowrap;
        }
        
        .history-table th,
        .history-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
        }
        
        .profile-pic-small {
            width: 40px;
            height: 40px;
        }
        
        .person-icon {
            width: 40px;
            height: 40px;
            font-size: 18px !important;
        }
        
        .badge {
            font-size: 0.7rem;
            padding: 0.4rem 0.8rem;
        }
        
        .undo-btn {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
        }
    }
    
    @media (max-width: 480px) {
        .form-group {
            max-width: 100%;
            padding: 0 0.5rem;
        }
        .form-control {
            min-width: 70vw;
            max-width: 85vw;
            font-size: 0.9rem;
        }
        .custom-select-wrapper {
            min-width: 70vw;
            max-width: 85vw;
        }
        .custom-select {
            min-width: 70vw;
            max-width: 85vw;
        }
        .history-table th,
        .history-table td {
            padding: 0.5rem 0.25rem;
            font-size: 0.8rem;
        }
        
        .profile-pic-small {
            width: 30px;
            height: 30px;
        }
        
        .person-icon {
            width: 30px;
            height: 30px;
            font-size: 16px !important;
        }
        
        .badge {
            font-size: 0.65rem;
            padding: 0.3rem 0.6rem;
        }
        
        .undo-btn {
            font-size: 0.7rem;
            padding: 0.4rem 0.8rem;
        }
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 80%;
        max-width: 500px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        position: relative;
    }
    
    .close {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        color: #aaa;
        font-size: 1.5rem;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: black;
    }
    
    .modal-actions {
        margin-top: 2rem;
        text-align: right;
    }
    
    .modal-actions button {
        margin-left: 0.5rem;
    }
    
    .danger {
        background-color: #dc3545;
    }
    
    .danger:hover {
        background-color: #c82333;
    }
    
    /* Search input styles */
    .search-input-wrapper {
        position: relative;
        width: 100%;
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid rgba(13, 52, 113, 0.2);
        border-radius: var(--border-radius);
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--primary-bg);
        box-shadow: 0 0 0 3px rgba(13, 52, 113, 0.1);
    }
    
    /* Suggestions dropdown */
    .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid rgba(13, 52, 113, 0.2);
        border-top: none;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 100%;
        box-sizing: border-box;
    }
    
    .suggestions-dropdown.show {
        display: block;
    }
    
    .suggestion-item {
        padding: 0.75rem;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid rgba(13, 52, 113, 0.05);
    }
    
    .suggestion-item:hover {
        background-color: rgba(13, 52, 113, 0.05);
    }
    
    .suggestion-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #f5f5f5;
    }
    
    .suggestion-item.disabled:hover {
        background-color: #f5f5f5;
    }
    
    .suggestion-item img {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 0.75rem;
        flex-shrink: 0;
    }
    
    .suggestion-item .person-icon {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.5rem;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        color: #6c757d;
        margin-right: 0.75rem;
        vertical-align: middle;
        flex-shrink: 0;
    }
    
    .suggestion-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
    }
    
    .suggestion-name {
        font-weight: 600;
        color: var(--heading-color);
    }
    
    .suggestion-council {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .no-suggestions {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
    }
</style>

<script>
    // User data from template
    const allUsers = [
        {% for user in users %}
        {
            id: '{{ user.id }}',
            name: '{{ user.first_name }} {{ user.last_name }}',
            fullName: '{{ user.first_name }} {{ user.second_name }} {{ user.last_name }}',
            council: '{{ user.council.name|default:"No Council" }}',
            img: '{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static "images/default-profile.png" %}{% endif %}'
        },
        {% endfor %}
    ];
    
    document.addEventListener('DOMContentLoaded', function() {
        // Searchable input functionality
        function setupSearchableInput(searchInputId, suggestionsId, hiddenInputId) {
            const searchInput = document.getElementById(searchInputId);
            const suggestionsDiv = document.getElementById(suggestionsId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm.length === 0) {
                    suggestionsDiv.classList.remove('show');
                    return;
                }
                
                // Filter users based on search term
                const filtered = allUsers.filter(user => 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.council.toLowerCase().includes(searchTerm)
                );
                
                // Render suggestions
                renderSuggestions(filtered, suggestionsDiv, searchInputId, hiddenInputId);
                suggestionsDiv.classList.add('show');
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== searchInput && e.target !== suggestionsDiv) {
                    suggestionsDiv.classList.remove('show');
                }
            });
        }
        
        function renderSuggestions(users, container, searchInputId, hiddenInputId) {
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = '<div class="no-suggestions">No users found</div>';
                return;
            }
            
            users.forEach(user => {
                const isDisabled = isUserDisabled(user.id, searchInputId);
                const item = document.createElement('div');
                item.className = `suggestion-item ${isDisabled ? 'disabled' : ''}`;
                
                const isDefaultProfile = user.img.includes('default-profile.png');
                
                if (isDefaultProfile) {
                    item.innerHTML = `
                        <i class="fas fa-user-circle person-icon"></i>
                        <div class="suggestion-info">
                            <span class="suggestion-name">${user.fullName}</span>
                            <span class="suggestion-council">${user.council}</span>
                        </div>
                    `;
                } else {
                    item.innerHTML = `
                        <img src="${user.img}" alt="${user.name}">
                        <div class="suggestion-info">
                            <span class="suggestion-name">${user.fullName}</span>
                            <span class="suggestion-council">${user.council}</span>
                        </div>
                    `;
                }
                
                if (!isDisabled) {
                    item.addEventListener('click', function() {
                        document.getElementById(searchInputId).value = user.name;
                        document.getElementById(hiddenInputId).value = user.id;
                        container.classList.remove('show');
                        updateDisabledStates();
                    });
                }
                
                container.appendChild(item);
            });
        }
        
        function isUserDisabled(userId, searchInputId) {
            const recruiterId = document.getElementById('recruiter_id').value;
            const recruitId = document.getElementById('recruit_id').value;
            
            // Check if already recruited
            const alreadyRecruited = isAlreadyRecruited(userId);
            
            // Check if same user selected in other field
            if (searchInputId === 'recruiter_search' && userId === recruitId) {
                return true;
            }
            if (searchInputId === 'recruit_search' && userId === recruiterId) {
                return true;
            }
            
            // For recruit field, also check if already recruited
            if (searchInputId === 'recruit_search' && alreadyRecruited) {
                return true;
            }
            
            return false;
        }
        
        function isAlreadyRecruited(userId) {
            const rows = document.querySelectorAll('.history-table tbody tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const recruitCell = cells[1];
                    if (recruitCell && recruitCell.hasAttribute('data-user-id')) {
                        if (recruitCell.getAttribute('data-user-id') === userId) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function updateDisabledStates() {
            // Re-render suggestions for both inputs
            const recruiterSearch = document.getElementById('recruiter_search');
            const recruitSearch = document.getElementById('recruit_search');
            
            if (recruiterSearch.value) {
                const filtered = allUsers.filter(user => 
                    user.name.toLowerCase().includes(recruiterSearch.value.toLowerCase())
                );
                renderSuggestions(filtered, document.getElementById('recruiter_suggestions'), 'recruiter_search', 'recruiter_id');
            }
            
            if (recruitSearch.value) {
                const filtered = allUsers.filter(user => 
                    user.name.toLowerCase().includes(recruitSearch.value.toLowerCase())
                );
                renderSuggestions(filtered, document.getElementById('recruit_suggestions'), 'recruit_search', 'recruit_id');
            }
        }
        
        // Setup searchable inputs
        setupSearchableInput('recruiter_search', 'recruiter_suggestions', 'recruiter_id');
        setupSearchableInput('recruit_search', 'recruit_suggestions', 'recruit_id');
        
        // Update disabled states when selections change
        document.getElementById('recruiter_id').addEventListener('change', updateDisabledStates);
        document.getElementById('recruit_id').addEventListener('change', updateDisabledStates);
        
        
        // Modal functionality
        const modal = document.getElementById('confirmationModal');
        const undoButtons = document.querySelectorAll('.undo-btn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.querySelector('.cancel-btn');
        const undoForm = document.getElementById('undoForm');
        const recruiterNameSpan = document.getElementById('recruiterName');
        const recruitNameSpan = document.getElementById('recruitName');
        
        undoButtons.forEach(button => {
            button.addEventListener('click', function() {
                const historyId = this.getAttribute('data-id');
                const recruiterName = this.getAttribute('data-recruiter');
                const recruitName = this.getAttribute('data-recruit');
                
                recruiterNameSpan.textContent = recruiterName;
                recruitNameSpan.textContent = recruitName;
                undoForm.action = `{% url 'undo_recruitment' 0 %}`.replace('0', historyId);
                
                modal.style.display = 'block';
            });
        });
        
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
{% endblock %} 